<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Base de Datos Dr Perez ‚Ä¢ Subida de informes</title>

  <style>
    :root{
      --bg0:#f6f9ff;
      --bg1:#ffffff;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;

      --accent:#1d4ed8;
      --accent2:#1e40af;
      --accentSoft: rgba(29,78,216,.10);

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1100px 600px at 12% 0%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(900px 520px at 92% 8%, rgba(29,78,216,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
    }

    .wrap{ max-width: 980px; margin:0 auto; padding:22px; }

    /* Header (igual vibe que viewer) */
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px 16px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
    }
    .title{
      font-size:20px;
      font-weight:900;
      letter-spacing:.2px;
      margin:0;
      line-height:1.15;
    }
    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .brand-right{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:86px;height:86px;
      object-fit:cover;
      border-radius: 18px;
      border:1px solid rgba(29,78,216,.25);
      box-shadow: 0 10px 22px rgba(29,78,216,.18);
      background: #fff;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      box-shadow: 0 4px 18px rgba(15,23,42,.06);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }

    .panel{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 0 0 6px 2px;
      font-weight: 800;
    }

    input, textarea, select{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      outline: none;
      font-size: 14px;
      transition: border-color .15s ease, box-shadow .15s ease;
      appearance: none;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(29,78,216,.55);
      box-shadow: 0 0 0 4px rgba(29,78,216,.12);
    }
    textarea{ min-height: 88px; resize: vertical; }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .btn{
      cursor:pointer;
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.90);
      color: var(--ink);
      font-weight: 900;
      font-size: 14px;
      transition: transform .03s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
      user-select:none;
    }
    .btn:hover{ background: rgba(29,78,216,.06); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{
      opacity: .55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .btn.primary{
      border-color: rgba(29,78,216,.35);
      background: linear-gradient(135deg, rgba(29,78,216,.92), rgba(30,64,175,.92));
      color: white;
    }
    .btn.primary:hover{ filter: brightness(1.02); }

    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .drop{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 2px dashed rgba(29,78,216,.28);
      padding: 16px;
      background: linear-gradient(180deg, rgba(29,78,216,.08), rgba(255,255,255,.75));
    }
    .drop.dragover{
      border-color: rgba(29,78,216,.65);
      box-shadow: 0 0 0 4px rgba(29,78,216,.12);
    }
    .dropTitle{
      font-weight: 900;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .dropSub{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .files{
      margin-top: 12px;
      display:grid;
      gap: 8px;
    }

    .file{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
    }
    .fileName{
      font-weight: 900;
      font-size: 13px;
      line-height: 1.2;
      word-break: break-word;
    }
    .fileMeta{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .tag{
      font-size: 12px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.02);
      white-space: nowrap;
    }
    .tag.ok{ border-color: rgba(22,163,74,.30); color: var(--ok); background: rgba(22,163,74,.08); }
    .tag.bad{ border-color: rgba(239,68,68,.30); color: var(--bad); background: rgba(239,68,68,.06); }
    .tag.warn{ border-color: rgba(245,158,11,.35); color: var(--warn); background: rgba(245,158,11,.08); }

    .progress{
      height: 10px;
      border-radius: 999px;
      overflow:hidden;
      background: rgba(15,23,42,.08);
      margin-top: 12px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(135deg, rgba(29,78,216,.92), rgba(30,64,175,.92));
      transition: width .12s ease;
    }

    .result{
      margin-top: 14px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.9);
    }
    code{
      background: rgba(29,78,216,.10);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 12px;
      font-family: var(--mono);
    }
    pre{
      margin: 10px 0 0 0;
      background: rgba(15,23,42,.06);
      padding: 10px;
      border-radius: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
      color: #111827;
      font-family: var(--mono);
    }

    a.link{
      color: var(--accent2);
      text-decoration: none;
      font-weight: 900;
    }
    a.link:hover{ text-decoration: underline; }

    /* Nav (iconos a otras p√°ginas) */
    .navlinks{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    a.navbtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.72);
      box-shadow: 0 4px 18px rgba(15,23,42,.06);
      font-size: 12px; color: var(--muted);
      text-decoration:none; font-weight: 900;
      white-space: nowrap;
    }
    a.navbtn:hover{ background: rgba(29,78,216,.06); border-color: rgba(29,78,216,.25); color: var(--ink); }

    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
      .header{ flex-direction: column; align-items:flex-start; }
      .brand-right{ width:100%; justify-content:space-between; }
      .pill{ align-self: flex-start; }
    }
    @media (max-width: 480px){
      .wrap{ padding: 14px; }
      .panel{ padding: 14px; }
      .btn{ width: 100%; }
      .row{ gap: 8px; }
      .file{ flex-direction: column; align-items: flex-start; }
      .file .row{ width:100%; }
      .logo{ width:76px; height:76px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="title">Base de Datos Dr Perez</h1>
        <div class="subtitle">
          Subida de informes (PDF). Se env√≠a <b>1 request por PDF</b> al webhook de n8n (1 ejecuci√≥n por estudio).
          <br/>
          <div class="navlinks">
            <a class="navbtn" href="./index.html" title="Subida">‚¨ÜÔ∏è Subida</a>
            <a class="navbtn" href="./viewer.html" title="Viewer">üîé Viewer</a>
            <a class="navbtn" href="./stats.html" title="Stats">üìä Stats</a>
          </div>
        </div>
      </div>

      <div class="brand-right">
        <div class="pill"><span class="dot"></span> Modo seguro: seud√≥nimos</div>
        <img class="logo"
          alt="Logo"
          src="https://raw.githubusercontent.com/Rafamaro/Base-de-datos-endoscopia/main/WhatsApp%20Image%202026-02-03%20at%2022.23.15.jpeg">
      </div>
    </div>

    <div class="panel">
      <div class="grid">
        <div>
          <label for="endpoint">Webhook n8n (Production)</label>
          <input id="endpoint" placeholder="https://n8n.drperez86.com/webhook/endodb/process-exam" inputmode="url" />
          <div class="hint">
            Se env√≠a <code>multipart/form-data</code> con <code>file</code> (PDF) + metadatos.
            <br/>
            Si ves ‚ÄúProcesando‚Äù sin respuesta, es normal: la subida termin√≥ pero el servidor tarda (Cloudflare a veces corta la respuesta).
          </div>
        </div>

        <div>
          <label for="patient_code">Paciente seud√≥nimo</label>
          <input id="patient_code" placeholder="Paciente_001" />
          <div class="hint">No pongas DNI/nombre. Esto viaja como texto al workflow.</div>
        </div>

        <div>
          <label for="procedure_type">Tipo de procedimiento</label>
          <select id="procedure_type">
            <option value="VCC">VCC</option>
            <option value="VEDA">VEDA</option>
          </select>
          <div class="hint">Se aplica al lote actual (todos los PDFs seleccionados).</div>
        </div>

        <div>
          <label for="notes">Notas internas (opcional)</label>
          <textarea id="notes" placeholder="Ej: control post polipectom√≠a, anticoagulaci√≥n, etc. (sin datos identificatorios)"></textarea>
          <div class="hint">Se env√≠an las mismas notas para todos los PDFs del lote.</div>
        </div>

        <div>
          <label>Acciones</label>
          <div class="row">
            <input  id="filepicker"  type="file"  accept="application/pdf,image/jpeg,image/png,image/heic,image/webp"  multiple  style="display:none"/>
            <button class="btn" id="btnPick" type="button">Elegir PDFs</button>
            <button class="btn primary" id="btnUpload" type="button" disabled>Subir y procesar</button>
            <button class="btn" id="btnClear" type="button" disabled>Limpiar</button>
          </div>

          <div class="progress" aria-label="progreso" title="Progreso total del lote">
            <div class="bar" id="bar"></div>
          </div>

          <div class="hint">
            Se suben en serie (uno tras otro).
          </div>
        </div>

        <div>
          <label>Estado</label>
          <div class="hint" id="statusLine">‚Äî</div>
          <div class="hint" style="margin-top:10px">
            Campos enviados por cada PDF:
            <br/>
            ‚Ä¢ <code>file</code> (binario PDF)
            <br/>
            ‚Ä¢ <code>exam_id</code> (UUID generado por el navegador)
            <br/>
            ‚Ä¢ <code>patient_code</code> (seud√≥nimo)
            <br/>
            ‚Ä¢ <code>procedure_type</code> (VCC/VEDA)
            <br/>
            ‚Ä¢ <code>client_filename</code> (opcional)
            <br/>
            ‚Ä¢ <code>notes</code> (opcional)
          </div>
        </div>
      </div>

      <div class="drop" id="drop">
        <div class="dropTitle">Arrastr√° y solt√° aqu√≠</div>
        <div class="dropSub">Pod√©s soltar varios PDFs. Se enviar√°n uno por uno.</div>
        <div class="files" id="files"></div>
      </div>

      <div class="result" id="result" style="display:none"></div>
    </div>
  </div>

<script>
(() => {
  const DEFAULT_ENDPOINT = "https://n8n.drperez86.com/webhook/endodb/process-exam";

  // Si Cloudflare corta la respuesta por tardanza, ac√° lo convertimos en "Procesando" (no error).
  // Se activa SOLO cuando el upload ya termin√≥ y la respuesta no llega a tiempo.
  const POST_UPLOAD_GRACE_MS = 85000; // ~85s: t√≠pico umbral antes del ‚Äúcorte‚Äù en proxies/CDN

  const elEndpoint = document.getElementById("endpoint");
  const elPatient = document.getElementById("patient_code");
  const elProc = document.getElementById("procedure_type");
  const elNotes = document.getElementById("notes");

  const elDrop = document.getElementById("drop");
  const elFiles = document.getElementById("files");
  const elPicker = document.getElementById("filepicker");
  const btnPick = document.getElementById("btnPick");
  const btnUpload = document.getElementById("btnUpload");
  const btnClear = document.getElementById("btnClear");
  const elBar = document.getElementById("bar");
  const elResult = document.getElementById("result");
  const elStatusLine = document.getElementById("statusLine");

  elEndpoint.value = DEFAULT_ENDPOINT;

  // queue items: { id, file, status: "pending|uploading|processing|ok|error", response, error }
  /** @type {{id:string,file:File,status:string,response?:any,error?:any,exam_id?:string}[]} */
  let queue = [];
  let uploading = false;

  const allowed = (file) => {
  const t = (file.type || "").toLowerCase();
  const n = (file.name || "").toLowerCase();

  if (t === "application/pdf" || n.endsWith(".pdf")) return true;
  if (t.startsWith("image/")) return true; // jpg/png/webp/heic (seg√∫n navegador)
  if (n.endsWith(".heic")) return true;    // backup por si el navegador no pone mimeType

  return false;
};


  const fmtSize = (n) => {
    const u = ["B","KB","MB","GB"];
    let i = 0, x = n;
    while (x >= 1024 && i < u.length-1) { x/=1024; i++; }
    return `${x.toFixed(i===0?0:1)} ${u[i]}`;
  };

  const setProgress = (p) => {
    elBar.style.width = `${Math.max(0, Math.min(100, p))}%`;
  };

  const setResult = (html) => {
    elResult.style.display = "block";
    elResult.innerHTML = html;
  };

  const resetResult = () => {
    elResult.style.display = "none";
    elResult.innerHTML = "";
  };

  const refreshButtons = () => {
    const hasFiles = queue.length > 0;
    btnClear.disabled = !hasFiles || uploading;
    btnPick.disabled = uploading;
    const endpointOk = (elEndpoint.value || "").trim().length > 0;

    const bad = queue.some(x => !allowed(x.file));
    btnUpload.disabled = !(hasFiles && endpointOk && !bad && !uploading);
  };

  const statusPill = (status) => {
    const span = document.createElement("span");
    span.className = "tag " + (
      status === "ok" ? "ok" :
      status === "error" ? "bad" :
      status === "uploading" ? "warn" :
      status === "processing" ? "warn" : ""
    );
    span.textContent =
      status === "ok" ? "OK" :
      status === "error" ? "Error" :
      status === "uploading" ? "Subiendo" :
      status === "processing" ? "Procesando" : "Pendiente";
    return span;
  };

  const renderQueue = () => {
    elFiles.innerHTML = "";
    queue.forEach((it, idx) => {
      const div = document.createElement("div");
      div.className = "file";

      const left = document.createElement("div");
      left.style.flex = "1";
      left.innerHTML = `
        <div class="fileName">${escapeHtml(it.file.name)}</div>
        <div class="fileMeta">${escapeHtml(fmtSize(it.file.size))} ‚Ä¢ ${escapeHtml(it.file.type || "desconocido")}${it.exam_id ? ` ‚Ä¢ exam_id: <code>${escapeHtml(it.exam_id)}</code>` : ""}</div>
      `;

      const right = document.createElement("div");
      right.className = "row";

      const tagType = document.createElement("span");
      tagType.className = "tag " + (allowed(it.file) ? "ok" : "bad");
      tagType.textContent = allowed(it.file) ? "PDF" : "Solo PDF";

      const tagStatus = statusPill(it.status);

      const rm = document.createElement("button");
      rm.className = "btn";
      rm.type = "button";
      rm.textContent = "Quitar";
      rm.disabled = uploading && it.status === "uploading";
      rm.onclick = () => {
        if (uploading && it.status === "uploading") return;
        queue.splice(idx, 1);
        renderQueue();
        refreshButtons();
        refreshStatusLine();
      };

      right.appendChild(tagType);
      right.appendChild(tagStatus);
      right.appendChild(rm);

      div.appendChild(left);
      div.appendChild(right);
      elFiles.appendChild(div);
    });

    refreshButtons();
  };

  const refreshStatusLine = () => {
    const total = queue.length;
    const ok = queue.filter(x => x.status === "ok").length;
    const proc = queue.filter(x => x.status === "processing").length;
    const err = queue.filter(x => x.status === "error").length;
    const up = queue.filter(x => x.status === "uploading").length;
    const pend = queue.filter(x => x.status === "pending").length;

    if (!total) {
      elStatusLine.textContent = "‚Äî";
      return;
    }

    elStatusLine.textContent =
      `Total: ${total} ‚Ä¢ Pendientes: ${pend} ‚Ä¢ Subiendo: ${up} ‚Ä¢ Procesando: ${proc} ‚Ä¢ OK: ${ok} ‚Ä¢ Errores: ${err}`;
  };

  const addFiles = (files) => {
    resetResult();
    const arr = Array.from(files || []);
    if (!arr.length) return;

    const exists = new Set(queue.map(x => `${x.file.name}::${x.file.size}`));
    const toAdd = arr.filter(f => !exists.has(`${f.name}::${f.size}`));

    const mapped = toAdd.map(f => ({
      id: cryptoRandomId(),
      file: f,
      status: "pending",
      exam_id: genUUID(),
    }));

    queue = queue.concat(mapped);
    renderQueue();
    refreshStatusLine();
  };

  // Picker
  btnPick.addEventListener("click", () => elPicker.click());
  elPicker.addEventListener("change", (e) => addFiles(e.target.files));

  // Drag & Drop
  ["dragenter","dragover"].forEach(ev => elDrop.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation();
    elDrop.classList.add("dragover");
  }));
  ["dragleave","drop"].forEach(ev => elDrop.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation();
    elDrop.classList.remove("dragover");
  }));
  elDrop.addEventListener("drop", (e) => addFiles(e.dataTransfer.files));

  // Clear
  btnClear.addEventListener("click", () => {
    if (uploading) return;
    queue = [];
    renderQueue();
    setProgress(0);
    resetResult();
    refreshStatusLine();
  });

  elEndpoint.addEventListener("input", refreshButtons);

  // Upload sequentially (1 request por archivo)
  btnUpload.addEventListener("click", async () => {
    resetResult();
    setProgress(0);

    const url = (elEndpoint.value || "").trim();
    const notes = (elNotes.value || "").trim();
    const patient_code = (elPatient.value || "").trim();
    const procedure_type = (elProc.value || "VCC").trim();

    const bad = queue.filter(it => !allowed(it.file));
    if (bad.length) {
      setResult(`<div><b>Hay archivos no permitidos.</b> Solo PDF.</div>`);
      return;
    }
    if (!queue.length) {
      setResult(`<div><b>No hay archivos.</b> Eleg√≠ uno o varios PDFs.</div>`);
      return;
    }

    uploading = true;
    refreshButtons();

    // Reset statuses for a fresh run (solo los que no est√°n OK)
    queue = queue.map(it => (it.status === "ok" ? it : ({...it, status:"pending", response: undefined, error: undefined})));
    renderQueue();
    refreshStatusLine();

    const totalBytes = queue.reduce((acc, it) => acc + (it.file?.size || 0), 0);
    let doneBytes = 0;

    const responses = [];

    for (let i = 0; i < queue.length; i++) {
      const it = queue[i];
      if (it.status === "ok") {
        doneBytes += it.file.size;
        setProgress(totalBytes ? (doneBytes / totalBytes) * 100 : 0);
        continue;
      }

      it.status = "uploading";
      renderQueue();
      refreshStatusLine();

      try {
        const payload = await uploadOne(url, it.file, {
          exam_id: it.exam_id,
          patient_code,
          procedure_type,
          notes,
        }, (loaded) => {
          const p = totalBytes ? ((doneBytes + loaded) / totalBytes) * 100 : 0;
          setProgress(p);
        });

        if (payload && payload.pending === true) {
          it.status = "processing";
          it.response = payload;
          responses.push({ file: it.file.name, ok: true, processing: true, response: payload });
        } else {
          it.status = "ok";
          it.response = payload;
          responses.push({ file: it.file.name, ok: true, response: payload });
        }

        doneBytes += it.file.size;
        setProgress(totalBytes ? (doneBytes / totalBytes) * 100 : 100);

      } catch (err) {
        it.status = "error";
        it.error = err;
        responses.push({ file: it.file.name, ok: false, error: String(err && err.message ? err.message : err) });

        doneBytes += it.file.size;
        setProgress(totalBytes ? (doneBytes / totalBytes) * 100 : 100);
      }

      renderQueue();
      refreshStatusLine();
    }

    uploading = false;
    refreshButtons();
    refreshStatusLine();

    const okCount = responses.filter(r => r.ok && !r.processing).length;
    const procCount = responses.filter(r => r.ok && r.processing).length;
    const errCount = responses.filter(r => !r.ok).length;

    setResult(`
      <div style="display:grid;gap:10px">
        <div><b>Listo.</b> Enviados: <code>${responses.length}</code> ‚Ä¢ OK: <code>${okCount}</code> ‚Ä¢ Procesando: <code>${procCount}</code> ‚Ä¢ Errores: <code>${errCount}</code></div>
        <div class="hint">
          Si queda en <b>Procesando</b>, el upload ya se complet√≥ pero el servidor tard√≥ en responder. Revis√° luego en el Viewer.
        </div>
        <details>
          <summary style="cursor:pointer;font-weight:900;color:var(--muted)">Ver respuestas</summary>
          <pre>${escapeHtml(JSON.stringify(responses, null, 2))}</pre>
        </details>
      </div>
    `);
  });

  function uploadOne(url, file, meta, onProgress){
    return new Promise((resolve, reject) => {
      const form = new FormData();
      form.append("file", file, file.name);
      form.append("client_filename", file.name);

      // Metadatos (para tu workflow)
      if (meta && meta.exam_id) form.append("exam_id", meta.exam_id);
      if (meta && meta.patient_code) form.append("patient_code", meta.patient_code);
      if (meta && meta.procedure_type) form.append("procedure_type", meta.procedure_type);
      if (meta && meta.notes) form.append("notes", meta.notes);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);

      let settled = false;
      let uploadDone = false;
      let graceTimer = null;

      const settleOk = (payload) => {
        if (settled) return;
        settled = true;
        if (graceTimer) clearTimeout(graceTimer);
        resolve(payload);
      };

      const settleErr = (err) => {
        if (settled) return;
        settled = true;
        if (graceTimer) clearTimeout(graceTimer);
        reject(err);
      };

      // Progreso upload
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable && typeof onProgress === "function") {
          onProgress(e.loaded);
        }
      };

      // Cuando el upload termina, empezamos el ‚Äúgrace‚Äù (si la respuesta tarda, marcamos como procesando)
      xhr.upload.onloadend = () => {
        uploadDone = true;
        if (POST_UPLOAD_GRACE_MS > 0) {
          graceTimer = setTimeout(() => {
            // Si todav√≠a no hay respuesta, abortamos para que el front no lo marque como error,
            // y lo dejamos como "Procesando". El workflow puede seguir corriendo del lado del servidor.
            if (settled) return;
            try { xhr.abort(); } catch {}
            settleOk({
              pending: true,
              note: "Upload completado; respuesta tard√≥ demasiado (posible timeout de proxy/CDN).",
            });
          }, POST_UPLOAD_GRACE_MS);
        }
      };

      xhr.onreadystatechange = () => {
        if (xhr.readyState !== 4 || settled) return;

        const ct = xhr.getResponseHeader("content-type") || "";
        let payload;
        try {
          payload = ct.includes("application/json") ? JSON.parse(xhr.responseText) : { raw: xhr.responseText };
        } catch {
          payload = { raw: xhr.responseText };
        }

        const isOk = xhr.status >= 200 && xhr.status < 300;

        // Si el proxy devolvi√≥ timeout/errores ‚Äúde respuesta‚Äù pero el upload termin√≥,
        // lo tratamos como "Procesando" (no error).
        const proxyTimeoutLike = [408, 499, 502, 503, 504, 520, 521, 522, 523, 524].includes(xhr.status);

        if (!isOk) {
          if (uploadDone && (proxyTimeoutLike || xhr.status === 0)) {
            settleOk({
              pending: true,
              http_status: xhr.status,
              note: "Upload completado; respuesta cortada por proxy/CDN.",
              response: payload,
            });
            return;
          }
          settleErr(new Error(`HTTP ${xhr.status} - ${safeShort(payload)}`));
          return;
        }

        settleOk(payload);
      };

      xhr.onerror = () => {
        // Si fall√≥ la conexi√≥n pero el upload ya termin√≥, lo marcamos como procesando.
        if (uploadDone) {
          settleOk({ pending: true, note: "Upload completado; error de red durante la espera de respuesta." });
          return;
        }
        settleErr(new Error("Fall√≥ la conexi√≥n (network error)."));
      };

      xhr.onabort = () => {
        // Si lo abortamos por grace timer, ya resolvimos arriba.
        if (!settled && uploadDone) {
          settleOk({ pending: true, note: "Abortado localmente tras upload completo (modo tolerante a timeouts)." });
        }
      };

      xhr.send(form);
    });
  }

  function safeShort(obj){
    try {
      const s = JSON.stringify(obj);
      return s.length > 220 ? s.slice(0,220) + "‚Ä¶" : s;
    } catch {
      return String(obj);
    }
  }

  function escapeHtml(str) {
    return (str ?? "").toString().replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function cryptoRandomId(){
    try {
      const a = new Uint8Array(8);
      crypto.getRandomValues(a);
      return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join("");
    } catch {
      return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
    }
  }

  function genUUID(){
    try {
      if (crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
    } catch {}
    // fallback: pseudo-uuid
    const s4 = () => Math.floor((1+Math.random())*0x10000).toString(16).slice(1);
    return `${s4()}${s4()}-${s4()}-${s4()}-${s4()}-${s4()}${s4()}${s4()}`;
  }

  // init
  renderQueue();
  refreshStatusLine();
  refreshButtons();
})();
</script>
</body>
</html>


