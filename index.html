<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EndoDB • Subida de informes</title>

  <!-- Tipografía moderna (Inter). Si no carga, cae a system-ui -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#fff7ef;
      --bg1:#fffdf9;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:#e7ded4;
      --shadow: 0 8px 30px rgba(31,41,55,.08);

      --accent:#b45309;
      --accent2:#c2410c;
      --accentSoft:#fde6cf;
      --ok:#059669;
      --bad:#dc2626;
      --warn:#b45309;

      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 10% 10%, #ffe8d4 0%, transparent 55%),
        radial-gradient(900px 600px at 95% 0%, #fff1e4 0%, transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 14px;
    }

    h1{
      font-size: 20px;
      line-height: 1.2;
      margin: 0;
      letter-spacing: .2px;
    }

    .subtitle{
      margin-top: 6px;
      color:var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      box-shadow: 0 4px 18px rgba(31,41,55,.06);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 0 0 6px 2px;
    }

    input, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      outline: none;
      font-size: 14px;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    input:focus, textarea:focus{
      border-color: rgba(180,83,9,.45);
      box-shadow: 0 0 0 4px rgba(180,83,9,.12);
    }
    textarea{ min-height: 88px; resize: vertical; }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .btn{
      cursor:pointer;
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      font-weight: 700;
      font-size: 14px;
      transition: transform .03s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 6px 18px rgba(31,41,55,.06);
      user-select:none;
    }
    .btn:hover{ background: #fffaf4; }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{
      opacity: .55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .btn.primary{
      border-color: rgba(180,83,9,.35);
      background: linear-gradient(135deg, rgba(180,83,9,.92), rgba(194,65,12,.92));
      color: white;
    }
    .btn.primary:hover{ filter: brightness(1.02); }

    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .drop{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 2px dashed rgba(180,83,9,.28);
      padding: 16px;
      background: linear-gradient(180deg, rgba(253,230,207,.52), rgba(255,255,255,.75));
    }
    .drop.dragover{
      border-color: rgba(180,83,9,.65);
      box-shadow: 0 0 0 4px rgba(180,83,9,.12);
    }
    .dropTitle{
      font-weight: 800;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .dropSub{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .files{
      margin-top: 12px;
      display:grid;
      gap: 8px;
    }

    .file{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
    }
    .fileName{
      font-weight: 700;
      font-size: 13px;
      line-height: 1.2;
      word-break: break-word;
    }
    .fileMeta{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .tag{
      font-size: 12px;
      font-weight: 800;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.02);
      white-space: nowrap;
    }
    .tag.ok{ border-color: rgba(5,150,105,.30); color: var(--ok); background: rgba(5,150,105,.08); }
    .tag.bad{ border-color: rgba(220,38,38,.30); color: var(--bad); background: rgba(220,38,38,.06); }
    .tag.warn{ border-color: rgba(180,83,9,.35); color: var(--warn); background: rgba(180,83,9,.08); }

    .progress{
      height: 10px;
      border-radius: 999px;
      overflow:hidden;
      background: rgba(31,41,55,.08);
      margin-top: 12px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(135deg, rgba(180,83,9,.92), rgba(194,65,12,.92));
      transition: width .12s ease;
    }

    .result{
      margin-top: 14px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.9);
    }
    code{
      background: rgba(180,83,9,.10);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 12px;
    }
    pre{
      margin: 10px 0 0 0;
      background: rgba(31,41,55,.06);
      padding: 10px;
      border-radius: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
      color: #111827;
    }

    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
      .header{ flex-direction: column; }
      .pill{ align-self: flex-start; }
    }
    @media (max-width: 480px){
      .wrap{ padding: 14px; }
      .card{ padding: 14px; }
      .btn{ width: 100%; }
      .row{ gap: 8px; }
      .file{ flex-direction: column; align-items: flex-start; }
      .file .row{ width:100%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>EndoDB — Subida de informes (múltiples)</h1>
        <div class="subtitle">
          Subí uno o varios PDFs. El sistema enviará <b>1 request por PDF</b> al webhook de n8n (1 ejecución por estudio).
        </div>
      </div>
      <div class="pill"><span class="dot"></span> Modo seguro: seudónimos</div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="endpoint">Webhook n8n (Production)</label>
          <input id="endpoint" placeholder="https://n8n.drperez86.com/webhook/endodb/process-exam" inputmode="url" />
          <div class="hint">
            Se envía <code>multipart/form-data</code> con el campo <code>file</code> (PDF).
            <br/>
            <span class="hint">Tip: si esto se abre desde un dominio distinto al de n8n, tu n8n/proxy debe permitir CORS para requests AJAX.</span>
          </div>
        </div>

        <div>
          <label for="notes">Notas internas (opcional)</label>
          <textarea id="notes" placeholder="Ej: control post polipectomía, anticoagulación, etc. (sin datos identificatorios)"></textarea>
          <div class="hint">Se envían las mismas notas para todos los PDFs del lote.</div>
        </div>

        <div>
          <label>Acciones</label>
          <div class="row">
            <input id="filepicker" type="file" accept="application/pdf" multiple style="display:none" />
            <button class="btn" id="btnPick" type="button">Elegir PDFs</button>
            <button class="btn primary" id="btnUpload" type="button" disabled>Subir y procesar</button>
            <button class="btn" id="btnClear" type="button" disabled>Limpiar</button>
          </div>

          <div class="progress" aria-label="progreso" title="Progreso total del lote">
            <div class="bar" id="bar"></div>
          </div>

          <div class="hint">
            Se suben en serie (uno tras otro) para que n8n dispare el flujo por archivo.
          </div>
        </div>

        <div>
          <label>Estado</label>
          <div class="hint" id="statusLine">—</div>
          <div class="hint" style="margin-top:10px">
            Campo enviado por cada PDF:
            <br/>
            • <code>file</code> (binario PDF)
            <br/>
            • <code>client_filename</code> (texto, opcional)
            <br/>
            • <code>notes</code> (texto, opcional)
          </div>
        </div>
      </div>

      <div class="drop" id="drop">
        <div class="dropTitle">Arrastrá y soltá aquí</div>
        <div class="dropSub">Podés soltar varios PDFs. Se enviarán uno por uno.</div>
        <div class="files" id="files"></div>
      </div>

      <div class="result" id="result" style="display:none"></div>
    </div>
  </div>

<script>
(() => {
  const DEFAULT_ENDPOINT = "https://n8n.drperez86.com/webhook/endodb/process-exam";

  const elEndpoint = document.getElementById("endpoint");
  const elNotes = document.getElementById("notes");
  const elDrop = document.getElementById("drop");
  const elFiles = document.getElementById("files");
  const elPicker = document.getElementById("filepicker");
  const btnPick = document.getElementById("btnPick");
  const btnUpload = document.getElementById("btnUpload");
  const btnClear = document.getElementById("btnClear");
  const elBar = document.getElementById("bar");
  const elResult = document.getElementById("result");
  const elStatusLine = document.getElementById("statusLine");

  elEndpoint.value = DEFAULT_ENDPOINT;

  // queue items: { id, file, status: "pending|uploading|ok|error", response, error }
  /** @type {{id:string,file:File,status:string,response?:any,error?:any}[]} */
  let queue = [];
  let uploading = false;

  const allowed = (file) => file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");

  const fmtSize = (n) => {
    const u = ["B","KB","MB","GB"];
    let i = 0, x = n;
    while (x >= 1024 && i < u.length-1) { x/=1024; i++; }
    return `${x.toFixed(i===0?0:1)} ${u[i]}`;
  };

  const setProgress = (p) => {
    elBar.style.width = `${Math.max(0, Math.min(100, p))}%`;
  };

  const setResult = (html) => {
    elResult.style.display = "block";
    elResult.innerHTML = html;
  };

  const resetResult = () => {
    elResult.style.display = "none";
    elResult.innerHTML = "";
  };

  const refreshButtons = () => {
    const hasFiles = queue.length > 0;
    btnClear.disabled = !hasFiles || uploading;
    btnPick.disabled = uploading;
    const endpointOk = (elEndpoint.value || "").trim().length > 0;

    const bad = queue.some(x => !allowed(x.file));
    btnUpload.disabled = !(hasFiles && endpointOk && !bad && !uploading);
  };

  const statusPill = (status) => {
    const span = document.createElement("span");
    span.className = "tag " + (
      status === "ok" ? "ok" :
      status === "error" ? "bad" :
      status === "uploading" ? "warn" : ""
    );
    span.textContent =
      status === "ok" ? "OK" :
      status === "error" ? "Error" :
      status === "uploading" ? "Subiendo" : "Pendiente";
    return span;
  };

  const renderQueue = () => {
    elFiles.innerHTML = "";
    queue.forEach((it, idx) => {
      const div = document.createElement("div");
      div.className = "file";

      const left = document.createElement("div");
      left.style.flex = "1";
      left.innerHTML = `
        <div class="fileName">${escapeHtml(it.file.name)}</div>
        <div class="fileMeta">${escapeHtml(fmtSize(it.file.size))} • ${escapeHtml(it.file.type || "desconocido")}</div>
      `;

      const right = document.createElement("div");
      right.className = "row";

      const tagType = document.createElement("span");
      tagType.className = "tag " + (allowed(it.file) ? "ok" : "bad");
      tagType.textContent = allowed(it.file) ? "PDF" : "Solo PDF";

      const tagStatus = statusPill(it.status);

      const rm = document.createElement("button");
      rm.className = "btn";
      rm.type = "button";
      rm.textContent = "Quitar";
      rm.disabled = uploading && it.status === "uploading";
      rm.onclick = () => {
        if (uploading && it.status === "uploading") return;
        queue.splice(idx, 1);
        renderQueue();
        refreshButtons();
        refreshStatusLine();
      };

      right.appendChild(tagType);
      right.appendChild(tagStatus);
      right.appendChild(rm);

      div.appendChild(left);
      div.appendChild(right);
      elFiles.appendChild(div);
    });

    refreshButtons();
  };

  const refreshStatusLine = () => {
    const total = queue.length;
    const ok = queue.filter(x => x.status === "ok").length;
    const err = queue.filter(x => x.status === "error").length;
    const up = queue.filter(x => x.status === "uploading").length;
    const pend = queue.filter(x => x.status === "pending").length;

    if (!total) {
      elStatusLine.textContent = "—";
      return;
    }

    elStatusLine.textContent = `Total: ${total} • Pendientes: ${pend} • Subiendo: ${up} • OK: ${ok} • Errores: ${err}`;
  };

  const addFiles = (files) => {
    resetResult();
    const arr = Array.from(files || []);
    if (!arr.length) return;

    // Evitar duplicados por nombre+size (simple)
    const exists = new Set(queue.map(x => `${x.file.name}::${x.file.size}`));
    const toAdd = arr.filter(f => !exists.has(`${f.name}::${f.size}`));

    const mapped = toAdd.map(f => ({
      id: cryptoRandomId(),
      file: f,
      status: "pending",
    }));

    queue = queue.concat(mapped);
    renderQueue();
    refreshStatusLine();
  };

  // Picker
  btnPick.addEventListener("click", () => elPicker.click());
  elPicker.addEventListener("change", (e) => addFiles(e.target.files));

  // Drag & Drop
  ["dragenter","dragover"].forEach(ev => elDrop.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation();
    elDrop.classList.add("dragover");
  }));
  ["dragleave","drop"].forEach(ev => elDrop.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation();
    elDrop.classList.remove("dragover");
  }));
  elDrop.addEventListener("drop", (e) => addFiles(e.dataTransfer.files));

  // Clear
  btnClear.addEventListener("click", () => {
    if (uploading) return;
    queue = [];
    renderQueue();
    setProgress(0);
    resetResult();
    refreshStatusLine();
  });

  elEndpoint.addEventListener("input", refreshButtons);

  // Upload sequentially (1 request por archivo)
  btnUpload.addEventListener("click", async () => {
    resetResult();
    setProgress(0);

    const url = (elEndpoint.value || "").trim();
    const notes = (elNotes.value || "").trim();

    const bad = queue.filter(it => !allowed(it.file));
    if (bad.length) {
      setResult(`<div><b>Hay archivos no permitidos.</b> Solo PDF.</div>`);
      return;
    }
    if (!queue.length) {
      setResult(`<div><b>No hay archivos.</b> Elegí uno o varios PDFs.</div>`);
      return;
    }

    uploading = true;
    refreshButtons();

    // Reset statuses for a fresh run (solo los que no están OK)
    queue = queue.map(it => (it.status === "ok" ? it : ({...it, status:"pending", response: undefined, error: undefined})));
    renderQueue();
    refreshStatusLine();

    // total size for global progress
    const totalBytes = queue.reduce((acc, it) => acc + (it.file?.size || 0), 0);
    let doneBytes = 0;

    const responses = [];

    for (let i = 0; i < queue.length; i++) {
      const it = queue[i];
      if (it.status === "ok") {
        doneBytes += it.file.size;
        setProgress(totalBytes ? (doneBytes / totalBytes) * 100 : 0);
        continue;
      }

      // mark uploading
      it.status = "uploading";
      renderQueue();
      refreshStatusLine();

      try {
        const payload = await uploadOne(url, it.file, notes, (loaded) => {
          const p = totalBytes ? ((doneBytes + loaded) / totalBytes) * 100 : 0;
          setProgress(p);
        });

        it.status = "ok";
        it.response = payload;
        responses.push({ file: it.file.name, ok: true, response: payload });

        doneBytes += it.file.size;
        setProgress(totalBytes ? (doneBytes / totalBytes) * 100 : 100);

      } catch (err) {
        it.status = "error";
        it.error = err;
        responses.push({ file: it.file.name, ok: false, error: String(err && err.message ? err.message : err) });

        // aun si falla, consideramos ese tamaño como "hecho" para no clavar la barra
        doneBytes += it.file.size;
        setProgress(totalBytes ? (doneBytes / totalBytes) * 100 : 100);
      }

      renderQueue();
      refreshStatusLine();
    }

    uploading = false;
    refreshButtons();
    refreshStatusLine();

    // Summary
    const okCount = responses.filter(r => r.ok).length;
    const errCount = responses.length - okCount;

    setResult(`
      <div style="display:grid;gap:10px">
        <div><b>Listo.</b> Enviados: <code>${responses.length}</code> • OK: <code>${okCount}</code> • Errores: <code>${errCount}</code></div>
        <div class="hint">Se disparó el workflow 1 vez por PDF (1 estudio = 1 request).</div>
        <details>
          <summary style="cursor:pointer;font-weight:700">Ver respuestas</summary>
          <pre>${escapeHtml(JSON.stringify(responses, null, 2))}</pre>
        </details>
      </div>
    `);
  });

  function uploadOne(url, file, notes, onProgress){
    return new Promise((resolve, reject) => {
      const form = new FormData();
      form.append("file", file, file.name);
      form.append("client_filename", file.name);
      if (notes) form.append("notes", notes);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable && typeof onProgress === "function") {
          onProgress(e.loaded);
        }
      };

      xhr.onreadystatechange = () => {
        if (xhr.readyState !== 4) return;

        const isOk = xhr.status >= 200 && xhr.status < 300;
        const ct = xhr.getResponseHeader("content-type") || "";

        let payload;
        try {
          payload = ct.includes("application/json") ? JSON.parse(xhr.responseText) : { raw: xhr.responseText };
        } catch (e) {
          payload = { raw: xhr.responseText };
        }

        if (!isOk) {
          const msg = `HTTP ${xhr.status} - ${safeShort(payload)}`;
          reject(new Error(msg));
          return;
        }

        resolve(payload);
      };

      xhr.onerror = () => reject(new Error("Falló la conexión (network error)."));
      xhr.send(form);
    });
  }

  function safeShort(obj){
    try {
      const s = JSON.stringify(obj);
      return s.length > 220 ? s.slice(0,220) + "…" : s;
    } catch {
      return String(obj);
    }
  }

  function escapeHtml(str) {
    return (str ?? "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function cryptoRandomId(){
    // Simple ID (sin depender de UUID libs)
    try {
      const a = new Uint8Array(8);
      crypto.getRandomValues(a);
      return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join("");
    } catch {
      return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
    }
  }

  // init
  renderQueue();
  refreshStatusLine();
  refreshButtons();
})();
</script>
</body>
</html>
