<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stats ‚Ä¢ EndoDB</title>
  <style>
    :root{
      --bg0:#f6f9ff; --bg1:#ffffff; --card:#fff; --ink:#0f172a; --muted:#475569;
      --line:#e2e8f0; --shadow:0 10px 30px rgba(15,23,42,.08); --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--ink);
      background:
        radial-gradient(1100px 600px at 12% 0%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(900px 520px at 92% 8%, rgba(29,78,216,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .wrap{max-width:1350px;margin:0 auto;padding:22px}
    .header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      background:var(--card);border:1px solid var(--line);border-radius:var(--r);
      padding:16px;box-shadow:var(--shadow);
    }
    h1{margin:0;font-size:20px;font-weight:900}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.45}
    .nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    a.btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.75);text-decoration:none;color:var(--muted);font-weight:900;
    }
    a.btn:hover{background:rgba(29,78,216,.06);border-color:rgba(29,78,216,.25);color:var(--ink)}
    .tag{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);background:rgba(29,78,216,.06);font-size:12px;color:var(--muted);font-weight:900}
    .panel{
      margin-top:14px;background:var(--card);border:1px solid var(--line);border-radius:var(--r);
      padding:14px;box-shadow:var(--shadow);
    }
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);border-radius:16px;background:#fff;padding:12px;box-shadow:var(--shadow)}
    .k{font-size:12px;color:var(--muted);font-weight:900}
    .v{font-size:22px;font-weight:950;margin-top:6px}
    .muted{color:var(--muted);font-size:12px}
    table{
      width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);
      border-radius:14px;overflow:hidden;background:#fff;
    }
    thead th{
      background:rgba(15,23,42,.02);color:var(--muted);font-size:12px;text-align:left;
      padding:10px;border-bottom:1px solid var(--line);white-space:nowrap;
    }
    tbody td{
      padding:10px;border-bottom:1px solid rgba(226,232,240,.85);font-size:13px;vertical-align:top;
      white-space:nowrap;
    }
    tbody tr:hover td{background:rgba(29,78,216,.06)}
    details{margin-top:12px}
    pre{margin:0;background:#0b1220;color:#e5e7eb;padding:12px;border-radius:14px;overflow:auto;font-family:var(--mono);font-size:12px}
    button{
      padding:11px;border-radius:12px;border:1px solid var(--line);
      background:rgba(29,78,216,.10);font-weight:900;cursor:pointer
    }
    button:hover{background:rgba(29,78,216,.14)}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Stats ‚Ä¢ EndoDB</h1>
        <div class="sub">
          Calidad (VCC) + Registro general (multi-usuario). Conteos mensuales salen de Tabla 3.
          M√©tricas de calidad salen de Tabla 2 (sin cruces).
          <div class="nav">
            <a class="btn" href="./index.html">‚¨ÜÔ∏è Subida</a>
            <a class="btn" href="./viewer.html">üîé Viewer</a>
            <a class="btn" href="./stats.html">üìä Stats</a>
          </div>
        </div>
      </div>
      <div class="tag">Worker: <span id="baseUrlText" style="font-family:var(--mono)"></span></div>
    </div>

    <div class="panel">
      <div class="bar">
        <div class="muted" id="status">‚Äî</div>
        <button id="btnRun">Recalcular</button>
      </div>

      <div class="grid">
        <div class="card">
          <div class="k">Entubaci√≥n cecal (Tabla 2)</div>
          <div class="v" id="kCecal">‚Äî</div>
          <div class="muted" id="kCecalMeta">‚Äî</div>
        </div>
        <div class="card">
          <div class="k">Calidad preparaci√≥n (Boston, Tabla 2)</div>
          <div class="v" id="kPrep">‚Äî</div>
          <div class="muted" id="kPrepMeta">‚Äî</div>
        </div>
        <div class="card">
          <div class="k">ADR (adenoma ‚â•1, Tabla 2)</div>
          <div class="v" id="kAdr">‚Äî</div>
          <div class="muted" id="kAdrMeta">‚Äî</div>
        </div>
        <div class="card">
          <div class="k">Tiempo de salida (promedio, Tabla 2)</div>
          <div class="v" id="kSalida">‚Äî</div>
          <div class="muted" id="kSalidaMeta">‚Äî</div>
        </div>
        <div class="card">
          <div class="k">Estudios totales (Tabla 3)</div>
          <div class="v" id="kTotal">‚Äî</div>
          <div class="muted">Total de filas procesadas.</div>
        </div>
        <div class="card">
          <div class="k">VCC totales (Tabla 3)</div>
          <div class="v" id="kVcc">‚Äî</div>
          <div class="muted">Seg√∫n tipo de estudio.</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="k">Conteos por mes (Tabla 3)</div>
        <div class="muted">Total, VCC/VEDA con/sin terap√©utica.</div>
        <div style="overflow:auto;max-height:520px;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Mes</th>
                <th>Total</th>
                <th>VCC</th>
                <th>VCC con tera</th>
                <th>VCC sin tera</th>
                <th>VEDA</th>
                <th>VEDA con tera</th>
                <th>VEDA sin tera</th>
              </tr>
            </thead>
            <tbody id="tbodyMonths"></tbody>
          </table>
        </div>
      </div>

      <details>
        <summary style="cursor:pointer;font-weight:900;color:var(--muted)">Debug</summary>
        <pre id="debug">(vac√≠o)</pre>
      </details>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // === CONFIG ===
  const CONFIG = {
    baseUrl: "", // relativo para Cloudflare Access
    scopeQuality: "calidad",
    scopeRegistry: "registro"
  };

  // Mapeos ‚Äúprobables‚Äù (si alguna no detecta, lo vemos en Debug)
  const AUTO = {
    // Tabla 3
    dateKeys: ["fecha","date","Fecha","FECHA"],
    procKeys: ["tipo_estudio","procedure_type","tipo","estudio","Tipo estudio"],
    therKeys: ["terapeutica","terap√©utica","therapeutica","terapia"],

    // Tabla 2
    cecalKeys: ["llego_a_ciego","lleg√≥_a_ciego","ciego","cecal_intubation","entubacion_cecal","entubaci√≥n_cecal"],
    bTotalKeys: ["boston_total","Boston total","boston"],
    bRKeys: ["boston_derecho","boston_derecha","derecho","right"],
    bTKeys: ["boston_transverso","transverso","transverse"],
    bLKeys: ["boston_izquierdo","izquierdo","left"],
    adenomaKeys: ["adenoma","adenoma_si","adr","tasa_adenoma"],
    salidaKeys: ["tiempo_salida","tiempo de salida","withdrawal_time","withdrawal","tiempo_salida_min"]
  };

  // === Bridge: permite que viewer consuma estas m√©tricas sin recalcular en viewer ===
  function publishStats(payload){
    try{
      if (window.parent && window.parent !== window){
        window.parent.postMessage({ type: "endodb_stats", payload }, "*");
      }
    } catch {}
  }

  window.addEventListener("message", (e) => {
    const d = e.data;
    if (!d || d.type !== "endodb_stats_run") return;
    run();
  });


  function normBaseUrl(u){
    u = (u||"").trim().replace(/\/+$/,"");
    if (!/^https?:\/\//i.test(u)) u = "https://" + u;
    return u;
  }

  async function fetchJson(url){
    const res = await fetch(url, {method:"GET"});
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e) {}
    return { ok: res.ok, status: res.status, text, json, url };
  }

  function normalizeColumns(colsJson){
    const arr = Array.isArray(colsJson) ? colsJson : (colsJson && Array.isArray(colsJson.data) ? colsJson.data : []);
    return arr.map(c => ({
      id: c.id ?? c.columnId ?? c._id ?? c,
      title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
    }));
  }

  function normalizeRows(rowsJson, cols){
    const colById = new Map(cols.map(c => [String(c.id), c.title]));
    const arr = Array.isArray(rowsJson) ? rowsJson : (rowsJson && Array.isArray(rowsJson.data) ? rowsJson.data : []);
    const out = [];
    for (const r of arr){
      const obj = {};
      const cells = r.data ?? r.values ?? r.cells ?? [];
      if (Array.isArray(cells)){
        for (const cell of cells){
          const cid = String(cell.columnId ?? cell.id ?? "");
          const key = colById.get(cid) || (cid ? `col_${cid}` : "col");
          obj[key] = cell.value ?? cell.value_json ?? cell.displayValue ?? cell.text ?? "";
        }
      }
      out.push(obj);
    }
    return out;
  }

  function guessBool(v){
    if (typeof v === "boolean") return v;
    if (v === null || v === undefined) return null;
    const s = String(v).trim().toLowerCase();
    if (["true","1","si","s√≠","y","yes"].includes(s)) return true;
    if (["false","0","no","n"].includes(s)) return false;
    return null;
  }


  function parseAdenoma(v){
    if (v === null || v === undefined) return null;
    const s = String(v).trim().toLowerCase();
    if (!s) return null;
    if (s.includes("pend")) return "PENDIENTE";
    if (["si","s√≠","true","1","y","yes"].includes(s)) return "SI";
    if (["no","false","0","n"].includes(s)) return "NO";
    // Si alguien escribe "adenoma" a secas, lo tomamos como s√≠.
    if (s.includes("adenom")) return "SI";
    return null;
  }

  function parseMinutes(v){
    if (v === null || v === undefined) return null;
    if (typeof v === "number" && isFinite(v)) return v;
    const s = String(v).trim().toLowerCase();
    if (!s) return null;

    // formatos tipo "10", "10.5", "10 min", "10 minutos"
    const m = s.match(/(-?\d+(?:[\.,]\d+)?)/);
    if (m){
      const num = parseFloat(m[1].replace(",", "."));
      return isFinite(num) ? num : null;
    }
    return null;
  }

  function parseMonth(v){
    if (v === null || v === undefined) return null;
    const s = String(v).trim();
    if (!s) return null;
    const m1 = s.match(/^(\d{4})[-/](\d{1,2})/);
    if (m1){
      const y = m1[1];
      const mm = String(Math.max(1, Math.min(12, parseInt(m1[2],10)))).padStart(2,"0");
      return `${y}-${mm}`;
    }
    const d = new Date(s);
    if (!Number.isNaN(d.getTime())){
      const y = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${mm}`;
    }
    return null;
  }

  function findKey(keys, candidates){
    const low = keys.map(k => [k, k.toLowerCase()]);
    for (const c of candidates){
      const cl = c.toLowerCase();
      const exact = low.find(([k, kl]) => kl === cl);
      if (exact) return exact[0];
    }
    for (const c of candidates){
      const cl = c.toLowerCase();
      const hit = low.find(([k, kl]) => kl.includes(cl));
      if (hit) return hit[0];
    }
    return null;
  }

  function pct(n, d){
    if (!d) return "‚Äî";
    return (100 * (n/d)).toFixed(1) + "%";
  }

  function asNum(v){
    const n = Number(String(v).replace(",", "."));
    return Number.isFinite(n) ? n : null;
  }

  async function loadScope(scope){
    const baseUrl = (CONFIG.baseUrl || "").replace(/\/+$/,"");
    // Multi-usuario: el Worker decide tabla seg√∫n email (Cloudflare Access)
    const urlCols = `${baseUrl}/api/${scope}/columns`;
    const urlRows = `${baseUrl}/api/${scope}/rows`;

    const [cRes, rRes] = await Promise.all([fetchJson(urlCols), fetchJson(urlRows)]);
    if (!cRes.ok || !rRes.ok){
      throw new Error(`Scope ${scope}: cols=${cRes.status} rows=${rRes.status}`);
    }
    const cols = normalizeColumns(cRes.json);
    const rows = normalizeRows(rRes.json, cols);
    return { scope, cols, rows, urlCols, urlRows };
  }

  function renderMonths(monthAgg){
    const tbody = $("tbodyMonths");
    tbody.innerHTML = "";
    const months = Array.from(monthAgg.keys()).sort();
    for (const m of months){
      const x = monthAgg.get(m);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m}</td>
        <td>${x.total}</td>
        <td>${x.vcc}</td>
        <td>${x.vcc_t}</td>
        <td>${x.vcc_nt}</td>
        <td>${x.veda}</td>
        <td>${x.veda_t}</td>
        <td>${x.veda_nt}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function run(){
    $("status").textContent = "Cargando tablas‚Ä¶";
    $("debug").textContent = "(cargando)";

    try{
      const [t2, t3] = await Promise.all([
        loadScope(CONFIG.scopeQuality),
        loadScope(CONFIG.scopeRegistry)
      ]);

      const keys2 = Object.keys(t2.rows[0] || {});
      const keys3 = Object.keys(t3.rows[0] || {});

      // Detectar columnas principales (Tabla 3)
      const kDate = findKey(keys3, AUTO.dateKeys);
      const kProc = findKey(keys3, AUTO.procKeys);
      const kTher = findKey(keys3, AUTO.therKeys);

      // Detectar columnas de calidad (Tabla 2)
      const kCecal = findKey(keys2, AUTO.cecalKeys);
      const kBT   = findKey(keys2, AUTO.bTotalKeys);
      const kBR   = findKey(keys2, AUTO.bRKeys);
      const kBTr  = findKey(keys2, AUTO.bTKeys);
      const kBL   = findKey(keys2, AUTO.bLKeys);
      const kAden = findKey(keys2, AUTO.adenomaKeys);
      const kSal  = findKey(keys2, AUTO.salidaKeys);

      // === Tabla 3: conteos por mes ===
      const monthAgg = new Map();
      let total = 0, vcc = 0;

      const isVcc = (v) => String(v||"").trim().toUpperCase() === "VCC";
      const isVeda = (v) => String(v||"").trim().toUpperCase() === "VEDA";
      const isTher = (v) => guessBool(v) === true || String(v||"").trim().toLowerCase() === "s√≠" || String(v||"").trim().toLowerCase() === "si";

      for (const r of t3.rows){
        total++;
        const m = kDate ? (parseMonth(r[kDate]) || "Sin mes") : "Sin mes";
        if (!monthAgg.has(m)){
          monthAgg.set(m, { total:0, vcc:0, vcc_t:0, vcc_nt:0, veda:0, veda_t:0, veda_nt:0 });
        }
        const a = monthAgg.get(m);
        a.total++;

        const proc = kProc ? r[kProc] : "";
        const ther = kTher ? r[kTher] : "";

        if (isVcc(proc)){
          vcc++; a.vcc++;
          if (isTher(ther)) a.vcc_t++; else a.vcc_nt++;
        } else if (isVeda(proc)){
          a.veda++;
          if (isTher(ther)) a.veda_t++; else a.veda_nt++;
        }
      }

      // ‚úÖ CAMBIO: Tabla 2 se calcula SOLO con Tabla 2 (sin cruces)
      let cecal_num = 0, cecal_den = 0;
      let prep_num  = 0, prep_den  = 0;
      let adr_num   = 0, adr_den   = 0, adr_pend = 0;
      const salida_vals = [];

      for (const r2 of t2.rows){

        // Cecal
        if (kCecal){
          const b = guessBool(r2[kCecal]);
          if (b !== null){
            cecal_den++;
            if (b === true) cecal_num++;
          }
        }

        // Boston calidad: total>=6 AND seg>=2
        if (kBT && kBR && kBTr && kBL){
          const bt  = asNum(r2[kBT]);
          const br  = asNum(r2[kBR]);
          const btr = asNum(r2[kBTr]);
          const bl  = asNum(r2[kBL]);

          const complete = [bt,br,btr,bl].every(x => x !== null);
          if (complete){
            prep_den++;
            if (bt >= 6 && br >= 2 && btr >= 2 && bl >= 2) prep_num++;
          }
        }

        // ADR (adenoma ‚â•1): se calcula con Tabla 2 (VCC)
        adr_den++;
        if (kAden){
          const st = parseAdenoma(r2[kAden]);
          if (st === "SI") adr_num++;
          else if (st === "PENDIENTE") adr_pend++;
        }

        // Tiempo de salida: minutos (Tabla 2)
        if (kSal){
          const min = parseMinutes(r2[kSal]);
          if (min !== null && isFinite(min) && min >= 0) salida_vals.push(min);
        }
      }

      // Render
      $("kTotal").textContent = total.toLocaleString();
      $("kVcc").textContent = vcc.toLocaleString();

      $("kCecal").textContent = pct(cecal_num, cecal_den);
      $("kCecalMeta").textContent = cecal_den ? `${cecal_num}/${cecal_den} filas con dato v√°lido` : "Sin datos parseables para ciego";

      $("kPrep").textContent = pct(prep_num, prep_den);
      $("kPrepMeta").textContent = prep_den ? `${prep_num}/${prep_den} filas con Boston completo` : "Sin Boston completo (total + 3 segmentos)";

      $("kAdr").textContent = pct(adr_num, adr_den);
      $("kAdrMeta").textContent = adr_den ? `${adr_num}/${adr_den} VCC con adenoma${adr_pend ? ` ‚Ä¢ ${adr_pend} pendientes` : ""}` : "Sin VCC para calcular";

      if (salida_vals.length){
        const mean = salida_vals.reduce((a,b)=>a+b,0)/salida_vals.length;
        $("kSalida").textContent = `${mean.toFixed(1)} min`;
        $("kSalidaMeta").textContent = `${salida_vals.length} filas con tiempo parseable`;
      } else {
        $("kSalida").textContent = "‚Äî";
        $("kSalidaMeta").textContent = "Sin tiempos parseables";
      }

      renderMonths(monthAgg);

      $("status").textContent = "OK";

      publishStats({
        cecal: { num: cecal_num, den: cecal_den },
        prep: { num: prep_num, den: prep_den },
        adr:  { num: adr_num, den: adr_den, pending: adr_pend },
        salida: { n: salida_vals.length, mean: salida_vals.length ? (salida_vals.reduce((a,b)=>a+b,0)/salida_vals.length) : null }
      });

      $("debug").textContent = JSON.stringify({
        config: CONFIG,
        detected: {
          table3: { date: kDate, proc: kProc, ther: kTher },
          table2: { cecal: kCecal, boston_total: kBT, boston_derecho: kBR, boston_transverso: kBTr, boston_izquierdo: kBL, adenoma: kAden, tiempo_salida: kSal }
        },
        counts: {
          table2_rows: t2.rows.length,
          table3_rows: t3.rows.length
        },
        quality: { cecal_num, cecal_den, prep_num, prep_den }
      }, null, 2);

      // Publicar a parent (viewer)

    } catch(err){
      $("status").textContent = "Error (ver debug)";
      const errText = String(err && err.stack ? err.stack : err);
      $("debug").textContent = errText;
      publishStats({ status: "Error", error: errText });
    }
  }

  function boot(){
    $("baseUrlText").textContent = (window.location.origin || "");
    $("btnRun").onclick = run;
    run();
  }

  boot();
</script>
</body>
</html>
