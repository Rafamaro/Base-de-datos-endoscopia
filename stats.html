<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inspector ‚Ä¢ EndoDB Stats</title>
  <style>
    :root{
      --bg0:#f6f9ff; --bg1:#ffffff; --card:#fff; --ink:#0f172a; --muted:#475569;
      --line:#e2e8f0; --accent:#1d4ed8; --shadow:0 10px 30px rgba(15,23,42,.08); --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--ink);
      background:
        radial-gradient(1100px 600px at 12% 0%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(900px 520px at 92% 8%, rgba(29,78,216,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .wrap{max-width:1350px;margin:0 auto;padding:22px}
    .header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      background:var(--card);border:1px solid var(--line);border-radius:var(--r);
      padding:16px;box-shadow:var(--shadow);
    }
    h1{margin:0;font-size:20px;font-weight:900}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.45}
    .nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    a.btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.75);text-decoration:none;color:var(--muted);font-weight:900;
    }
    a.btn:hover{background:rgba(29,78,216,.06);border-color:rgba(29,78,216,.25);color:var(--ink)}
    .panel{
      margin-top:14px;background:var(--card);border:1px solid var(--line);border-radius:var(--r);
      padding:14px;box-shadow:var(--shadow);
    }
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;align-items:start}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px;font-weight:900}
    input,select{
      width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);
      outline:none;background:#fff;
    }
    input[disabled]{background:rgba(15,23,42,.03); color:rgba(15,23,42,.75)}
    input:focus,select:focus{border-color:rgba(29,78,216,.55);box-shadow:0 0 0 4px rgba(29,78,216,.12)}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);border-radius:16px;background:#fff;padding:12px;
    }
    .k{font-size:12px;color:var(--muted);font-weight:900;margin-bottom:6px}
    .tag{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);background:rgba(29,78,216,.06);font-size:12px;color:var(--muted);font-weight:900}
    .ok{color:#0f766e}
    .bad{color:#b91c1c}
    table{
      width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);
      border-radius:14px;overflow:hidden;background:#fff;
    }
    thead th{
      background:rgba(15,23,42,.02);color:var(--muted);font-size:12px;text-align:left;
      padding:10px;border-bottom:1px solid var(--line);white-space:nowrap;
    }
    tbody td{
      padding:10px;border-bottom:1px solid rgba(226,232,240,.85);font-size:13px;vertical-align:top;
      max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    tbody tr:hover td{background:rgba(29,78,216,.06)}
    pre{
      margin:0;background:#0b1220;color:#e5e7eb;padding:12px;border-radius:14px;overflow:auto;
      font-family:var(--mono);font-size:12px;line-height:1.35;
    }
    details{margin-top:12px}
    .muted{color:var(--muted);font-size:12px}
    button{
      width:100%;padding:11px;border-radius:12px;border:1px solid var(--line);
      background:rgba(29,78,216,.10);font-weight:900;cursor:pointer
    }
    button:hover{background:rgba(29,78,216,.14)}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap}
    .btnrow button{flex:1;min-width:120px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Inspector de tablas ‚Ä¢ Nextcloud Tables</h1>
        <div class="sub">
          Esto es para ver <b>qu√© tabla y qu√© columnas</b> est√°s leyendo realmente desde el Worker.
          Despu√©s armamos las m√©tricas con nombres correctos (sin adivinar).
          <div class="nav">
            <a class="btn" href="./index.html">‚¨ÜÔ∏è Subida</a>
            <a class="btn" href="./viewer.html">üîé Viewer</a>
            <a class="btn" href="./stats.html">üß™ Inspector</a>
          </div>
        </div>
      </div>
      <div class="tag">Base URL Worker: <span id="baseUrlText" style="font-family:var(--mono)"></span></div>
    </div>

    <div class="panel">
      <div class="row">
        <div>
          <label>Worker baseUrl (fijo, como viewer)</label>
          <input id="baseUrl" disabled />
          <div class="muted">Si el d√≠a de ma√±ana cambia, se edita una sola l√≠nea en este archivo.</div>
        </div>

        <div>
          <label for="tableId">Table ID</label>
          <input id="tableId" placeholder="Ej: 2" inputmode="numeric" />
          <div class="muted">Us√° Enter o los botones r√°pidos.</div>
        </div>

        <div>
          <label>&nbsp;</label>
          <div class="btnrow">
            <button id="btnLoad2">Cargar 2</button>
            <button id="btnLoad3">Cargar 3</button>
            <button id="btnLoad">Cargar ID</button>
          </div>
          <div class="muted" id="status">‚Äî</div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="card">
          <div class="k">Columnas detectadas</div>
          <div class="muted" id="colsMeta">‚Äî</div>
          <div style="overflow:auto;max-height:320px;margin-top:10px">
            <table>
              <thead><tr><th>columnId</th><th>title</th></tr></thead>
              <tbody id="colsTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="k">Detecci√≥n autom√°tica (para m√©tricas)</div>
          <div id="detectBox" class="muted">‚Äî</div>

          <div style="margin-top:12px" class="k">Resumen</div>
          <div class="muted" id="summaryBox">‚Äî</div>

          <details>
            <summary style="cursor:pointer;font-weight:900;color:var(--muted)">Debug (raw)</summary>
            <pre id="debug">(vac√≠o)</pre>
          </details>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="k">Filas (muestra)</div>
        <div class="muted">
          Se muestran hasta <b>25 filas</b>. Si hay muchas columnas, vas a ver truncado (‚Ä¶).
        </div>
        <div style="overflow:auto;max-height:420px;margin-top:10px">
          <table>
            <thead><tr id="rowsThead"></tr></thead>
            <tbody id="rowsTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // === CONFIG (Fijo, como viewer) ===
  const DEFAULT_BASE_URL = "https://basededatos.corrongo182.workers.dev";

  // ‚úÖ CAMBIO CR√çTICO: asegurar protocolo SIEMPRE
  function normBaseUrl(s){
    let u = (s || "").trim().replace(/\/+$/,"");
    if (!u) return u;
    if (!/^https?:\/\//i.test(u)) u = "https://" + u;
    return u;
  }

  async function fetchText(url){
    const res = await fetch(url, { method:"GET" });
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e) {}
    return { ok: res.ok, status: res.status, text, json, url };
  }

  function normalizeColumns(colsJson){
    const arr = Array.isArray(colsJson) ? colsJson : (colsJson && Array.isArray(colsJson.data) ? colsJson.data : []);
    return arr.map(c => ({
      id: c.id ?? c.columnId ?? c._id ?? c,
      title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
    }));
  }

  function normalizeRows(rowsJson, cols){
    const colById = new Map(cols.map(c => [String(c.id), c.title]));
    const arr = Array.isArray(rowsJson) ? rowsJson : (rowsJson && Array.isArray(rowsJson.data) ? rowsJson.data : []);
    const out = [];
    for (const r of arr){
      const obj = {};
      obj["_row_id"] = r.id ?? r.rowId ?? r._id ?? "";
      const cells = r.data ?? r.values ?? r.cells ?? [];
      if (Array.isArray(cells)){
        for (const cell of cells){
          const cid = String(cell.columnId ?? cell.id ?? "");
          const key = colById.get(cid) || (cid ? `col_${cid}` : "col");
          obj[key] = cell.value ?? cell.value_json ?? cell.displayValue ?? cell.text ?? "";
        }
      }
      out.push(obj);
    }
    return out;
  }

  function findKey(keys, wanted){
    const low = keys.map(k => [k, k.toLowerCase()]);
    for (const w of wanted){
      const wl = w.toLowerCase();
      const exact = low.find(([k, kl]) => kl === wl);
      if (exact) return exact[0];
    }
    return null;
  }

  function findContains(keys, substrs){
    const low = keys.map(k => [k, k.toLowerCase()]);
    for (const s of substrs){
      const sl = s.toLowerCase();
      const hit = low.find(([k, kl]) => kl.includes(sl));
      if (hit) return hit[0];
    }
    return null;
  }

  function parseMonth(value){
    if (value === null || value === undefined) return null;
    const s = String(value).trim();
    if (!s) return null;

    const m1 = s.match(/^(\d{4})[-/](\d{1,2})/);
    if (m1){
      const y = m1[1];
      const mm = String(Math.max(1, Math.min(12, parseInt(m1[2],10)))).padStart(2,"0");
      return `${y}-${mm}`;
    }

    const d = new Date(s);
    if (!Number.isNaN(d.getTime())){
      const y = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${mm}`;
    }

    const m2 = s.match(/^(\d{1,2})[-/](\d{4})$/);
    if (m2){
      const mm = String(Math.max(1, Math.min(12, parseInt(m2[1],10)))).padStart(2,"0");
      const y = m2[2];
      return `${y}-${mm}`;
    }
    return null;
  }

  function guessBoolean(v){
    if (typeof v === "boolean") return v;
    if (v === null || v === undefined) return null;
    const s = String(v).trim().toLowerCase();
    if (["true","1","si","s√≠","y","yes"].includes(s)) return true;
    if (["false","0","no","n"].includes(s)) return false;
    return null;
  }

  function detectColumnsFromRow(row){
    const keys = Object.keys(row || {}).filter(k => k !== "_row_id");

    const keyDate =
      findContains(keys, ["fecha", "date"]) ||
      findContains(keys, ["mes", "month"]) ||
      null;

    const keyProc =
      findKey(keys, ["procedure_type","tipo_estudio","tipo de estudio","tipo"]) ||
      findContains(keys, ["procedure","proced","estudio","tipo"]) ||
      null;

    const keyTher =
      findKey(keys, ["terapeutica","terap√©utica","therapeutica","terapia","terapeutica_realizada"]) ||
      findContains(keys, ["terapeut", "terapia"]) ||
      null;

    const keyCecal =
      findKey(keys, ["llego_a_ciego","lleg√≥_a_ciego","ciego","cecal_intubation","entubacion_cecal","entubaci√≥n_cecal"]) ||
      findContains(keys, ["ciego","cecal","entub"]) ||
      null;

    return { keyDate, keyProc, keyTher, keyCecal, keys };
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderColumns(cols){
    const tbody = $("colsTbody");
    tbody.innerHTML = "";
    for (const c of cols){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="font-family:var(--mono)">${c.id}</td><td>${escapeHtml(c.title)}</td>`;
      tbody.appendChild(tr);
    }
    $("colsMeta").textContent = `${cols.length.toLocaleString()} columnas`;
  }

  function renderRows(rows){
    const thead = $("rowsThead");
    const tbody = $("rowsTbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const sample = rows.slice(0, 25);
    if (!sample.length){
      thead.innerHTML = `<th>Sin filas</th>`;
      return;
    }

    const keys = Object.keys(sample[0]);
    for (const k of keys){
      const th = document.createElement("th");
      th.textContent = k;
      thead.appendChild(th);
    }

    for (const r of sample){
      const tr = document.createElement("tr");
      for (const k of keys){
        const td = document.createElement("td");
        const v = r[k];
        td.textContent = (v === null || v === undefined) ? "" : String(v);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }

  function renderDetection(rows){
    if (!rows.length){
      $("detectBox").innerHTML = `<span class="bad">No hay filas para detectar columnas.</span>`;
      $("summaryBox").textContent = "‚Äî";
      return;
    }

    const det = detectColumnsFromRow(rows[0]);

    const mk = (label, key) => {
      if (!key) return `<div>‚Ä¢ ${label}: <span class="bad">NO detectado</span></div>`;
      return `<div>‚Ä¢ ${label}: <span class="ok">${escapeHtml(key)}</span></div>`;
    };

    $("detectBox").innerHTML = `
      ${mk("Fecha/Mes", det.keyDate)}
      ${mk("Tipo estudio", det.keyProc)}
      ${mk("Terap√©utica", det.keyTher)}
      ${mk("Ciego/Cecal", det.keyCecal)}
      <div class="muted" style="margin-top:8px">
        Si algo sale ‚ÄúNO detectado‚Äù, lo mapeamos manualmente despu√©s.
      </div>
    `;

    const monthKey = det.keyDate;
    let months = 0;
    if (monthKey){
      const set = new Set();
      for (const r of rows){
        const m = parseMonth(r[monthKey]);
        if (m) set.add(m);
      }
      months = set.size;
    }

    let therOk = 0, therTot = 0;
    if (det.keyTher){
      for (const r of rows){
        const b = guessBoolean(r[det.keyTher]);
        if (b !== null) therOk++;
        therTot++;
      }
    }

    $("summaryBox").innerHTML = `
      <div>‚Ä¢ Filas totales: <b>${rows.length.toLocaleString()}</b></div>
      <div>‚Ä¢ Columnas: <b>${det.keys.length.toLocaleString()}</b></div>
      <div>‚Ä¢ Meses detectables: <b>${months ? months : "‚Äî"}</b></div>
      <div>‚Ä¢ Terap√©utica parseable (bool): <b>${therTot ? (therOk + "/" + therTot) : "‚Äî"}</b></div>
    `;
  }

  async function load(){
    const baseUrl = normBaseUrl($("baseUrl").value);
    const tableId = String(($("tableId").value || "").trim());

    $("baseUrlText").textContent = baseUrl || "(vac√≠o)";
    $("status").textContent = "Cargando‚Ä¶";

    if (!baseUrl || !tableId){
      $("status").textContent = "Pon√© un Table ID.";
      return;
    }

    const urlCols = `${baseUrl}/nc/tables/${tableId}/columns`;
    const urlRows = `${baseUrl}/nc/tables/${tableId}/rows`;

    const [cRes, rRes] = await Promise.all([fetchText(urlCols), fetchText(urlRows)]);

    if (!cRes.ok || !rRes.ok){
      $("status").innerHTML = `<span class="bad">Error cargando.</span> cols=${cRes.status} rows=${rRes.status}`;
      $("debug").textContent = JSON.stringify({ columns: cRes, rows: rRes }, null, 2);
      return;
    }

    const cols = normalizeColumns(cRes.json);
    const rows = normalizeRows(rRes.json, cols);

    renderColumns(cols);
    renderRows(rows);
    renderDetection(rows);

    $("status").innerHTML = `<span class="ok">OK</span> ‚Ä¢ Tabla ${tableId} ‚Ä¢ filas=${rows.length.toLocaleString()} cols=${cols.length.toLocaleString()}`;
    $("debug").textContent = JSON.stringify({
      used: { baseUrl, tableId, urlCols, urlRows },
      sampleRow: rows[0] || null
    }, null, 2);
  }

  function boot(){
    $("baseUrl").value = DEFAULT_BASE_URL;
    $("baseUrlText").textContent = DEFAULT_BASE_URL;

    $("btnLoad").onclick = load;
    $("btnLoad2").onclick = () => { $("tableId").value = "2"; load(); };
    $("btnLoad3").onclick = () => { $("tableId").value = "3"; load(); };

    $("tableId").addEventListener("keydown", (e) => {
      if (e.key === "Enter") load();
    });
  }

  boot();
</script>
</body>
</html>
