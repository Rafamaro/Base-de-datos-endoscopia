<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EndoDB • Nextcloud Tables Viewer (via Worker)</title>

  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0f1a2e;
      --card:#101c33;
      --ink:#e7eefc;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.10);
      --ok:#36d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(167,139,250,.18), transparent 65%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .top{
      display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;
      margin-bottom:16px;
    }
    .brand{
      flex:1 1 320px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px 16px;
      box-shadow: var(--shadow);
      min-width: 280px;
    }
    .brand h1{margin:0 0 6px;font-size:18px}
    .brand p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}

    .card{
      flex:2 1 520px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      min-width: 320px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.3fr 0.7fr 0.7fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,18,34,.65);
      color:var(--ink);
      padding:10px 10px;
      outline:none;
    }
    input::placeholder{color:rgba(233,238,252,.45)}

    .row{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(96,165,250,.25), rgba(96,165,250,.12));
      color:var(--ink);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{ background: linear-gradient(180deg, rgba(167,139,250,.18), rgba(167,139,250,.08)); }
    .btn.ghost{ background: transparent; }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}

    .tabs{ display:flex;gap:10px;flex-wrap:wrap; margin:16px 0 10px; }
    .tab{
      padding:10px 12px;border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.15);
      cursor:pointer;color: var(--muted);user-select:none;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(96,165,250,.25), rgba(96,165,250,.10));
      color: var(--ink);
      border-color: rgba(96,165,250,.35);
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .panel-head{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;
      margin-bottom:10px;
    }
    .panel-head h2{margin:0;font-size:14px}
    .tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .tools input{width:260px;max-width:100%}

    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
    }
    thead th{
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:12px;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky; top:0;
      cursor:pointer; user-select:none; white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      font-size:13px;
      vertical-align:top;
      background: rgba(0,0,0,.10);
    }
    tbody tr:hover td{background: rgba(96,165,250,.10)}

    .footer{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-top:10px;color:var(--muted);font-size:12px;
    }
    .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pager button{
      padding:7px 10px;border-radius: 10px;border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.15); color:var(--ink); cursor:pointer;
    }
    .pager button:disabled{opacity:.55;cursor:not-allowed}

    details{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background: rgba(0,0,0,.12);
      padding:10px 12px;
    }
    summary{cursor:pointer;color:var(--muted);font-weight:600}
    pre{
      margin:10px 0 0;
      background: rgba(0,0,0,.30);
      padding:10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      overflow:auto;
      max-height: 320px;
      font-size:12px;
      line-height:1.35;
      font-family: var(--mono);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Viewer • Nextcloud Tables (via Cloudflare Worker)</h1>
        <p>
          Este viewer lee tablas de Nextcloud usando un proxy Worker para evitar CORS.
          Si algo falla, abrí Debug para ver la respuesta cruda.
        </p>
      </div>

      <div class="card">
        <div class="grid">
          <div>
            <label>Base URL del Worker</label>
            <input id="baseUrl" placeholder="https://basededatos.corrongo182.workers.dev" />
          </div>
          <div>
            <label>Table ID (BD)</label>
            <input id="t1" placeholder="2" />
          </div>
          <div>
            <label>Table ID (Estudios/mes)</label>
            <input id="t2" placeholder="3" />
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnLoad">Cargar</button>
          <button class="btn secondary" id="btnReload" disabled>Recargar</button>
          <button class="btn ghost" id="btnExport" disabled>Export CSV</button>

          <span class="pill" id="statusPill">
            <span class="dot warn"></span>
            <span id="statusText">Sin cargar</span>
          </span>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab1">Tabla</div>
      <div class="tab" id="tab2">Tabla</div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <h2 id="tableTitle">—</h2>
        <div class="tools">
          <input id="q" placeholder="Buscar…" />
          <input id="pageSize" placeholder="25" title="Filas por página" />
        </div>
      </div>

      <div style="overflow:auto; max-height: 62vh; border-radius:14px;">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div id="meta">—</div>
        <div class="pager">
          <button id="prev">◀</button>
          <span>Pág <span id="pageN">1</span> / <span id="pageMax">1</span></span>
          <button id="next">▶</button>
        </div>
      </div>

      <details>
        <summary>Debug</summary>
        <pre id="debug">(vacío)</pre>
      </details>
    </div>
  </div>

  <script>
    const KEY = {
      baseUrl: "endodb_worker_baseUrl",
      t1: "endodb_worker_t1",
      t2: "endodb_worker_t2",
    };

    const $ = (id) => document.getElementById(id);

    function setStatus(kind, text){
      const pill = $("statusPill");
      const dot = pill.querySelector(".dot");
      dot.className = "dot " + (kind || "warn");
      $("statusText").textContent = text;
    }

    async function fetchJson(url){
      const res = await fetch(url, { method: "GET" });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch(e) {}
      return { ok: res.ok, status: res.status, text, json };
    }

    function normalizeColumns(colsJson){
      if (Array.isArray(colsJson)) return colsJson.map(c => ({
        id: c.id ?? c.columnId ?? c._id ?? c,
        title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
      }));
      if (colsJson && Array.isArray(colsJson.data)) return colsJson.data.map(c => ({
        id: c.id ?? c.columnId ?? c._id ?? c,
        title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
      }));
      return [];
    }

    function normalizeRows(rowsJson, cols){
      const colById = new Map(cols.map(c => [String(c.id), c.title]));
      const unwrap = (x) => Array.isArray(x) ? x : (x && Array.isArray(x.data) ? x.data : []);
      const rowsArr = unwrap(rowsJson);
      const out = [];
      for (const r of rowsArr){
        const obj = {};
        obj["_row_id"] = r.id ?? r.rowId ?? r._id ?? "";
        const cells = r.data ?? r.values ?? r.cells ?? [];
        if (Array.isArray(cells)){
          for (const cell of cells){
            const cid = String(cell.columnId ?? cell.id ?? "");
            const key = colById.get(cid) || (cid ? `col_${cid}` : "col");
            obj[key] = cell.value ?? cell.value_json ?? cell.displayValue ?? cell.text ?? "";
          }
        }
        out.push(obj);
      }
      return out;
    }

    function toCsv(rows, columns){
      const esc = (v) => {
        if (v === null || v === undefined) return "";
        const s = String(v).replaceAll('"','""');
        return `"${s}"`;
      };
      const header = columns.map(c => esc(c)).join(",");
      const lines = rows.map(r => columns.map(c => esc(r[c])).join(","));
      return [header, ...lines].join("\n");
    }

    function downloadText(filename, content, mime="text/plain"){
      const blob = new Blob([content], {type:mime});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    const state = {
      activeIdx: 0,
      tables: [
        { id: 2, name: "Base de datos", cols: [], rows: [], raw: {} },
        { id: 3, name: "Estudios por mes", cols: [], rows: [], raw: {} },
      ],
      sortKey: null,
      sortDir: "asc",
      q: "",
      page: 1,
      pageSize: 25,
    };

    function setActive(idx){
      state.activeIdx = idx;
      state.sortKey = null;
      state.sortDir = "asc";
      state.page = 1;
      $("tab1").classList.toggle("active", idx===0);
      $("tab2").classList.toggle("active", idx===1);
      $("tableTitle").textContent = `${state.tables[idx].name} (ID ${state.tables[idx].id})`;
      render();
    }

    function render(){
      const t = state.tables[state.activeIdx];
      const rows0 = t.rows || [];
      const cols0 = t.cols || [];
      const colNames = ["_row_id", ...cols0.map(c => c.title)].filter((v, i, a) => a.indexOf(v) === i);

      const q = (state.q || "").trim().toLowerCase();
      let rows = rows0;
      if (q){
        rows = rows0.filter(r =>
          Object.keys(r).some(k => (r[k] ?? "").toString().toLowerCase().includes(q))
        );
      }

      if (state.sortKey){
        const k = state.sortKey;
        const dir = state.sortDir === "asc" ? 1 : -1;
        rows = [...rows].sort((a,b) => {
          const av = a[k] ?? "";
          const bv = b[k] ?? "";
          const an = Number(av), bn = Number(bv);
          const aNum = !Number.isNaN(an) && String(av).trim() !== "";
          const bNum = !Number.isNaN(bn) && String(bv).trim() !== "";
          if (aNum && bNum) return (an - bn) * dir;
          return String(av).localeCompare(String(bv), undefined, {numeric:true, sensitivity:"base"}) * dir;
        });
      }

      const ps = Math.max(1, state.pageSize|0);
      const total = rows.length;
      const maxPage = Math.max(1, Math.ceil(total / ps));
      state.page = Math.min(state.page, maxPage);
      const start = (state.page - 1) * ps;
      const pageRows = rows.slice(start, start + ps);

      const thead = $("thead");
      thead.innerHTML = "";
      const trh = document.createElement("tr");
      for (const c of colNames){
        const th = document.createElement("th");
        th.textContent = c === "_row_id" ? "row_id" : c;
        th.onclick = () => {
          if (state.sortKey === c){
            state.sortDir = (state.sortDir === "asc") ? "desc" : "asc";
          } else {
            state.sortKey = c;
            state.sortDir = "asc";
          }
          render();
        };
        trh.appendChild(th);
      }
      thead.appendChild(trh);

      const tbody = $("tbody");
      tbody.innerHTML = "";
      for (const r of pageRows){
        const tr = document.createElement("tr");
        for (const c of colNames){
          const td = document.createElement("td");
          td.textContent = (r[c] ?? "").toString();
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      $("meta").textContent =
        `${total.toLocaleString()} filas` +
        (q ? ` (filtradas por "${state.q}")` : "") +
        (state.sortKey ? ` • orden: ${state.sortKey} (${state.sortDir})` : "");

      $("pageN").textContent = String(state.page);
      $("pageMax").textContent = String(maxPage);
      $("prev").disabled = state.page <= 1;
      $("next").disabled = state.page >= maxPage;

      $("debug").textContent = JSON.stringify(t.raw, null, 2);
    }

    function saveSettings(){
      localStorage.setItem(KEY.baseUrl, $("baseUrl").value.trim());
      localStorage.setItem(KEY.t1, $("t1").value.trim());
      localStorage.setItem(KEY.t2, $("t2").value.trim());
    }

    function loadSettings(){
      $("baseUrl").value = localStorage.getItem(KEY.baseUrl) || "https://basededatos.corrongo182.workers.dev";
      $("t1").value = localStorage.getItem(KEY.t1) || "2";
      $("t2").value = localStorage.getItem(KEY.t2) || "3";
    }

    async function loadAll(){
      saveSettings();
      const baseUrl = $("baseUrl").value.trim().replace(/\/+$/,"");
      const t1 = Number($("t1").value.trim()) || 2;
      const t2 = Number($("t2").value.trim()) || 3;

      state.tables[0].id = t1;
      state.tables[1].id = t2;

      $("tab1").textContent = `Tabla ${t1}`;
      $("tab2").textContent = `Tabla ${t2}`;
      $("tableTitle").textContent = `${state.tables[state.activeIdx].name} (ID ${state.tables[state.activeIdx].id})`;

      setStatus("warn", "Cargando…");
      $("btnLoad").disabled = true;
      $("btnReload").disabled = true;
      $("btnExport").disabled = true;

      try{
        for (let i=0;i<2;i++){
          const tid = state.tables[i].id;

          const urlCols = `${baseUrl}/nc/tables/${tid}/columns`;
          const urlRows = `${baseUrl}/nc/tables/${tid}/rows`;

          const rCols = await fetchJson(urlCols);
          const rRows = await fetchJson(urlRows);

          state.tables[i].raw = {
            columns: { url: urlCols, ok: rCols.ok, status: rCols.status, json: rCols.json ?? rCols.text },
            rows:    { url: urlRows, ok: rRows.ok, status: rRows.status, json: rRows.json ?? rRows.text },
          };

          const cols = rCols.ok ? normalizeColumns(rCols.json) : [];
          const rows = rRows.ok ? normalizeRows(rRows.json, cols) : [];

          state.tables[i].cols = cols;
          state.tables[i].rows = rows;
        }

        const okAny = state.tables.some(t => (t.rows?.length || 0) > 0);
        setStatus(okAny ? "ok" : "warn", okAny ? "Cargado" : "Sin filas (ver Debug)");

        $("btnReload").disabled = false;
        $("btnExport").disabled = false;

        render();
      } catch (e){
        console.error(e);
        setStatus("bad", "Error (ver consola)");
      } finally {
        $("btnLoad").disabled = false;
      }
    }

    $("tab1").onclick = () => setActive(0);
    $("tab2").onclick = () => setActive(1);

    $("btnLoad").onclick = loadAll;
    $("btnReload").onclick = loadAll;

    $("q").addEventListener("input", (e) => {
      state.q = e.target.value || "";
      state.page = 1;
      render();
    });

    $("pageSize").addEventListener("input", (e) => {
      const n = parseInt(e.target.value || "25", 10);
      state.pageSize = Number.isFinite(n) && n > 0 ? n : 25;
      state.page = 1;
      render();
    });

    $("prev").onclick = () => { state.page = Math.max(1, state.page - 1); render(); };
    $("next").onclick = () => { state.page = state.page + 1; render(); };

    $("btnExport").onclick = () => {
      const t = state.tables[state.activeIdx];
      const cols = ["_row_id", ...(t.cols || []).map(c => c.title)].filter((v,i,a)=>a.indexOf(v)===i);
      const csv = toCsv(t.rows || [], cols);
      downloadText(`table_${t.id}.csv`, csv, "text/csv;charset=utf-8");
    };

    loadSettings();
    setActive(0);
  </script>
</body>
</html>
