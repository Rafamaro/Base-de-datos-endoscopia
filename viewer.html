<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EndoDB • Tabla VCC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#fffdf9;--card:#fff;--line:#e7ded4;--ink:#111827;--muted:#6b7280;--accent:#b45309;--shadow:0 10px 34px rgba(17,24,39,.10);--r:18px;}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .top{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;margin-bottom:12px}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);outline:none}
    input:focus{border-color:rgba(180,83,9,.45);box-shadow:0 0 0 4px rgba(180,83,9,.12)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .btn{height:40px;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(135deg,rgba(180,83,9,.92),rgba(194,65,12,.92));color:#fff;border-color:rgba(180,83,9,.35)}
    .tableWrap{border-radius:16px;border:1px solid var(--line);overflow:hidden;margin-top:10px}
    table{width:100%;border-collapse:collapse}
    thead th{background:rgba(253,230,207,.65);border-bottom:1px solid var(--line);font-size:12px;color:#374151;padding:10px 12px;text-align:left;white-space:nowrap}
    tbody td{border-bottom:1px solid rgba(231,222,212,.65);padding:10px 12px;font-size:13px}
    tbody tr{cursor:pointer}
    tbody tr:hover{background:rgba(180,83,9,.05)}
    tbody tr.sel{background:rgba(180,83,9,.10)}
    code{font-size:12px;background:rgba(180,83,9,.10);padding:2px 6px;border-radius:10px}
    .err{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(220,38,38,.35);background:rgba(220,38,38,.08);color:#7f1d1d;font-size:12px;white-space:pre-wrap;display:none}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>EndoDB • Tabla VCC</h1>
      <div class="muted">Lista y detalle desde n8n (vcc_results + fields_text).</div>
    </div>
    <div class="muted">Modo lectura</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div style="flex:1;min-width:260px">
          <label>API base (n8n)</label>
          <input id="api" placeholder="https://n8n.drperez86.com" />
        </div>
        <div style="flex:1;min-width:220px">
          <label>Buscar exam_id</label>
          <input id="q" placeholder="1271879" />
        </div>
        <div style="width:120px">
          <label>Límite</label>
          <input id="limit" value="100" />
        </div>
        <div style="width:120px">
          <label>Offset</label>
          <input id="offset" value="0" />
        </div>
        <button class="btn primary" id="reload">Recargar</button>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Exam ID</th>
              <th>Boston</th>
              <th>Ciego</th>
              <th>Pólipos</th>
              <th>Terapéutica</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="muted" id="meta" style="margin-top:8px">—</div>
      <div class="err" id="err"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
        <div>
          <div style="font-weight:800">Detalle</div>
          <div class="muted" id="dsub">—</div>
        </div>
        <button class="btn" id="copy" disabled>Copiar exam_id</button>
      </div>

      <div id="detail" style="margin-top:10px" class="muted">
        Seleccioná un examen en la tabla.
      </div>
      <div class="err" id="derr"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const DEFAULT_API = localStorage.getItem("endodb_n8n_api") || "https://n8n.drperez86.com";
  const elApi = document.getElementById("api");
  const elQ = document.getElementById("q");
  const elLimit = document.getElementById("limit");
  const elOffset = document.getElementById("offset");
  const btnReload = document.getElementById("reload");
  const tbody = document.getElementById("tbody");
  const meta = document.getElementById("meta");
  const err = document.getElementById("err");

  const dsub = document.getElementById("dsub");
  const detail = document.getElementById("detail");
  const derr = document.getElementById("derr");
  const btnCopy = document.getElementById("copy");

  let selected = null;

  elApi.value = DEFAULT_API;

  const normApi = s => (s||"").trim().replace(/\/+$/,"");
  const fmt = iso => iso ? new Date(iso).toLocaleString("es-AR",{dateStyle:"short",timeStyle:"short"}) : "—";

  const showErr = (el, msg) => { el.style.display = msg ? "block" : "none"; el.textContent = msg || ""; };

  async function jget(url){
    const r = await fetch(url, { headers: { "Accept":"application/json" }});
    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(`HTTP ${r.status}\n${t.slice(0,300)}`);
    }
    return await r.json();
  }

  function boolTxt(v){
    if (v === true) return "Sí";
    if (v === false) return "No";
    return "—";
  }

  async function loadList(){
    showErr(err, "");
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Cargando…</td></tr>`;

    const API = normApi(elApi.value);
    localStorage.setItem("endodb_n8n_api", API);

    const q = (elQ.value || "").trim();
    const limit = Number(elLimit.value || 100);
    const offset = Number(elOffset.value || 0);

    const url = `${API}/webhook/endodb/vcc/list?limit=${encodeURIComponent(limit)}&offset=${encodeURIComponent(offset)}&q=${encodeURIComponent(q)}`;

    try{
      const data = await jget(url);
      const items = data.items || [];
      meta.textContent = `Total: ${data.total ?? items.length} • Mostrando: ${items.length} • Offset: ${offset}`;

      tbody.innerHTML = "";
      if (!items.length){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Sin resultados</td></tr>`;
        return;
      }

      for (const it of items){
        const tr = document.createElement("tr");
        tr.classList.toggle("sel", selected === it.exam_id);
        tr.innerHTML = `
          <td>${fmt(it.updated_at || it.created_at)}</td>
          <td><code>${it.exam_id}</code></td>
          <td>${it.boston_total ?? "—"}</td>
          <td>${boolTxt(it.llego_a_ciego)}</td>
          <td>${boolTxt(it.polipos)}</td>
          <td>${boolTxt(it.terapeutica)}</td>
        `;
        tr.addEventListener("click", () => loadDetail(it.exam_id));
        tbody.appendChild(tr);
      }

      // auto-select first
      if (!selected) loadDetail(items[0].exam_id);

    }catch(e){
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Error</td></tr>`;
      showErr(err, String(e.message || e));
    }
  }

  async function loadDetail(exam_id){
    selected = String(exam_id);
    showErr(derr, "");
    dsub.textContent = `Exam ID: ${selected}`;
    detail.innerHTML = `<div class="muted">Cargando…</div>`;

    btnCopy.disabled = false;
    btnCopy.onclick = async () => { try{ await navigator.clipboard.writeText(selected); }catch{} };

    const API = normApi(elApi.value);
    const url = `${API}/webhook/endodb/vcc/detail?exam_id=${encodeURIComponent(selected)}`;

    try{
      const data = await jget(url);
      const s = data.summary || {};
      const fields = data.fields || [];

      const f = (name) => {
        const x = fields.find(r => r.field_name === name);
        return x ? x.value_json : null;
      };

      detail.innerHTML = `
        <div style="font-weight:800;margin-bottom:6px">Resumen (vcc_results)</div>
        <div class="muted" style="margin-bottom:10px">
          Boston: <b>${s.boston_total ?? "—"}</b> • Izq: <b>${s.boston_izquierdo ?? "—"}</b> • Transv: <b>${s.boston_transverso ?? "—"}</b> • Der: <b>${s.boston_derecho ?? "—"}</b><br>
          Ciego: <b>${boolTxt(s.llego_a_ciego)}</b> • Pólipos: <b>${boolTxt(s.polipos)}</b> • Terapéutica: <b>${boolTxt(s.terapeutica)}</b>
        </div>

        <div style="font-weight:800;margin-bottom:6px">Campos guardados (fields_text)</div>
        <div class="tableWrap">
          <table>
            <thead><tr><th>field_name</th><th>value_json</th><th>updated_at</th></tr></thead>
            <tbody>
              ${fields.map(r => `
                <tr>
                  <td><code>${r.field_name}</code></td>
                  <td><code>${JSON.stringify(r.value_json)}</code></td>
                  <td class="muted">${fmt(r.updated_at)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;

      // rehighlight selection
      document.querySelectorAll("#tbody tr").forEach(tr => {
        const code = tr.querySelector("code")?.textContent;
        tr.classList.toggle("sel", code === selected);
      });

    }catch(e){
      showErr(derr, String(e.message || e));
      detail.innerHTML = `<div class="muted">Error cargando detalle</div>`;
    }
  }

  btnReload.addEventListener("click", loadList);
  elQ.addEventListener("keydown", (e) => { if (e.key === "Enter") loadList(); });

  loadList();
})();
</script>
</body>
</html>
