<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Base de Datos Dr Perez • Viewer</title>

  <style>
    :root{
      --bg0:#f6f9ff;
      --bg1:#ffffff;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;

      --accent:#1d4ed8;      /* azul rey */
      --accent2:#1e40af;
      --accentSoft: rgba(29,78,216,.10);

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1100px 600px at 12% 0%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(900px 520px at 92% 8%, rgba(29,78,216,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
    }

    .wrap{max-width:1350px;margin:0 auto;padding:22px}

    /* Header */
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px 16px;
      box-shadow: var(--shadow);
    }
    .title{
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
      margin:0;
      line-height:1.15;
    }
    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
    }
    .brand-right{
      display:flex;align-items:center;gap:10px;
    }
    .logo{
      width:86px;height:86px;
      object-fit:cover;
      border-radius: 18px;
      border:1px solid rgba(29,78,216,.25);
      box-shadow: 0 10px 22px rgba(29,78,216,.18);
      background: #fff;
    }

    /* Stats row */
    .stats{
      width:100%;
      display:grid;
      grid-template-columns: 1.2fr 0.8fr 0.8fr;
      gap:10px;
      margin:14px 0 14px;
    }
    @media (max-width: 980px){
      .stats{grid-template-columns:1fr}
    }
    .stat{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(29,78,216,.06), rgba(255,255,255,1));
      border-radius: 16px;
      padding:12px;
      min-height: 74px;
    }
    .stat .k{font-size:12px;color:var(--muted);margin-bottom:6px}
    .stat .v{font-size:16px;font-weight:900;letter-spacing:.2px}
    .stat .s{font-size:12px;color:var(--muted);margin-top:4px}

    /* Tabs */
    .tabs{ display:flex;gap:10px;flex-wrap:wrap; margin:0 0 10px; }
    .tab{
      padding:10px 12px;border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      cursor:pointer;color: var(--muted);user-select:none;
      font-weight:900;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(29,78,216,.18), rgba(29,78,216,.06));
      color: var(--ink);
      border-color: rgba(29,78,216,.30);
    }

    /* Layout for table view + month sidebar */
    .layout{
      display:block;
    }
    .layout.withSidebar{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
    }

    .sidebar{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
      height: calc(62vh + 90px);
      overflow:auto;
      display:none;
    }
    .sidebar.show{display:block}
    .side-title{
      margin:0 0 10px;
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .month{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      margin-bottom:8px;
      font-weight:900;
      color: var(--ink);
    }
    .month small{color: var(--muted); font-weight:800}
    .month.active{
      border-color: rgba(29,78,216,.35);
      background: linear-gradient(180deg, rgba(29,78,216,.16), rgba(29,78,216,.06));
    }

    /* Panel + table */
    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .panel-head{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;
      margin-bottom:10px;
    }
    .panel-head h2{margin:0;font-size:14px}
    .tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input{
      border-radius: 12px;
      border:1px solid var(--line);
      background: #fff;
      color:var(--ink);
      padding:10px 10px;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
      width:260px; max-width:100%;
    }
    input:focus{
      border-color: rgba(29,78,216,.55);
      box-shadow: 0 0 0 4px rgba(29,78,216,.12);
    }
    input.small{width:120px}
    input::placeholder{color:rgba(71,85,105,.55)}

    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius: 14px;
      border:1px solid var(--line);
    }
    thead th{
      background: rgba(15,23,42,.02);
      color: var(--muted);
      font-size:12px;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      cursor:pointer; user-select:none; white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(226,232,240,.85);
      font-size:13px;
      vertical-align:top;
      background: #fff;
    }
    tbody tr:hover td{background: rgba(29,78,216,.06)}

    .footer{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-top:10px;color:var(--muted);font-size:12px;
    }
    .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pager button{
      padding:7px 10px;border-radius: 10px;border:1px solid var(--line);
      background: rgba(255,255,255,.85); color:var(--ink); cursor:pointer;
      font-weight:900;
    }
    .pager button:disabled{opacity:.55;cursor:not-allowed}

    details{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(15,23,42,.02);
      padding:10px 12px;
    }
    summary{cursor:pointer;color:var(--muted);font-weight:900}
    pre{
      margin:10px 0 0;
      background: rgba(15,23,42,.04);
      padding:10px;
      border-radius: 12px;
      border:1px solid var(--line);
      overflow:auto;
      max-height: 320px;
      font-size:12px;
      line-height:1.35;
      font-family: var(--mono);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="title">Base de Datos Dr Perez</h1>
        <p class="subtitle">Viewer de tablas (VCC y estadísticas por mes).</p>
      </div>
      <div class="brand-right">
        <img class="logo"
             alt="Logo"
             src="https://raw.githubusercontent.com/Rafamaro/Base-de-datos-endoscopia/main/WhatsApp%20Image%202026-02-03%20at%2022.23.15.jpeg">
      </div>
    </div>

    <!-- Stats (cambian según vista) -->
    <div class="stats">
      <div class="stat" id="s1">
        <div class="k" id="s1k">—</div>
        <div class="v" id="s1v">—</div>
        <div class="s" id="s1s">—</div>
      </div>
      <div class="stat" id="s2">
        <div class="k" id="s2k">—</div>
        <div class="v" id="s2v">—</div>
        <div class="s" id="s2s">—</div>
      </div>
      <div class="stat" id="s3">
        <div class="k" id="s3k">—</div>
        <div class="v" id="s3v">—</div>
        <div class="s" id="s3s">—</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab1">Base de datos de VCC</div>
      <div class="tab" id="tab2">Estudios por mes</div>
    </div>

    <div class="layout" id="layout">
      <!-- sidebar months -->
      <div class="sidebar" id="sidebar">
        <div class="side-title">Meses</div>
        <div id="months"></div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <h2 id="tableTitle">—</h2>
          <div class="tools">
            <input id="q" placeholder="Buscar en esta tabla…" />
            <input id="pageSize" class="small" placeholder="25" title="Filas por página" />
          </div>
        </div>
        <div id="alert" style="display:none; margin:8px 0 10px; padding:10px 12px; border-radius:14px; border:1px solid rgba(239,68,68,.25); background: rgba(239,68,68,.06); color: #7f1d1d; font-weight:800; font-size:12px;">No se pudieron cargar datos (ver Debug).</div>

        <div style="overflow:auto; max-height: 62vh; border-radius:14px;">
          <table>
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="footer">
          <div id="meta">—</div>
          <div class="pager">
            <button id="prev">◀</button>
            <span>Pág <span id="pageN">1</span> / <span id="pageMax">1</span></span>
            <button id="next">▶</button>
          </div>
        </div>

        <details>
          <summary>Debug</summary>
          <pre id="debug">(vacío)</pre>
        </details>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // ✅ Hardcode (pediste borrar UI de configuración)
    const CONFIG = {
      baseUrl: "https://basededatos.corrongo182.workers.dev",
      tableVccId: 2,
      tableByMonthId: 3,
    };

    async function fetchJson(url){
      const res = await fetch(url, { method: "GET" });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch(e) {}
      return { ok: res.ok, status: res.status, text, json };
    }

    function normalizeColumns(colsJson){
      if (Array.isArray(colsJson)) return colsJson.map(c => ({
        id: c.id ?? c.columnId ?? c._id ?? c,
        title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
      }));
      if (colsJson && Array.isArray(colsJson.data)) return colsJson.data.map(c => ({
        id: c.id ?? c.columnId ?? c._id ?? c,
        title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
      }));
      return [];
    }

    function normalizeRows(rowsJson, cols){
      const colById = new Map(cols.map(c => [String(c.id), c.title]));
      const unwrap = (x) => Array.isArray(x) ? x : (x && Array.isArray(x.data) ? x.data : []);
      const rowsArr = unwrap(rowsJson);
      const out = [];
      for (const r of rowsArr){
        const obj = {};
        obj["_row_id"] = r.id ?? r.rowId ?? r._id ?? "";
        const cells = r.data ?? r.values ?? r.cells ?? [];
        if (Array.isArray(cells)){
          for (const cell of cells){
            const cid = String(cell.columnId ?? cell.id ?? "");
            const key = colById.get(cid) || (cid ? `col_${cid}` : "col");
            obj[key] = cell.value ?? cell.value_json ?? cell.displayValue ?? cell.text ?? "";
          }
        }
        out.push(obj);
      }
      return out;
    }

    function guessBoolean(v){
      if (typeof v === "boolean") return v;
      if (v === null || v === undefined) return null;
      const s = String(v).trim().toLowerCase();
      if (["true","1","si","sí","y","yes"].includes(s)) return true;
      if (["false","0","no","n"].includes(s)) return false;
      return null;
    }

    function findKey(keys, wanted){
      const low = keys.map(k => [k, k.toLowerCase()]);
      for (const w of wanted){
        const wl = w.toLowerCase();
        const exact = low.find(([k, kl]) => kl === wl);
        if (exact) return exact[0];
      }
      return null;
    }

    function findContains(keys, substrs){
      const low = keys.map(k => [k, k.toLowerCase()]);
      for (const s of substrs){
        const sl = s.toLowerCase();
        const hit = low.find(([k, kl]) => kl.includes(sl));
        if (hit) return hit[0];
      }
      return null;
    }

    function parseMonth(value){
      if (value === null || value === undefined) return null;
      const s = String(value).trim();
      if (!s) return null;

      // If already like YYYY-MM
      const m1 = s.match(/^(\d{4})[-/](\d{1,2})/);
      if (m1){
        const y = m1[1];
        const mm = String(Math.max(1, Math.min(12, parseInt(m1[2],10)))).padStart(2,"0");
        return `${y}-${mm}`;
      }

      // Try Date parsing
      const d = new Date(s);
      if (!Number.isNaN(d.getTime())){
        const y = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        return `${y}-${mm}`;
      }

      // Try "MM/YYYY" or "MM-YYYY"
      const m2 = s.match(/^(\d{1,2})[-/](\d{4})$/);
      if (m2){
        const mm = String(Math.max(1, Math.min(12, parseInt(m2[1],10)))).padStart(2,"0");
        const y = m2[2];
        return `${y}-${mm}`;
      }

      return null;
    }

    const state = {
      activeIdx: 0,
      tables: [
        { id: CONFIG.tableVccId, name: "Base de datos de VCC", cols: [], rows: [], raw: {}, q:"", page:1, pageSize:25 },
        { id: CONFIG.tableByMonthId, name: "Estudios por mes", cols: [], rows: [], raw: {}, q:"", page:1, pageSize:25, monthKey: null, monthSelected: "ALL", months: [] },
      ],
      sortKey: null,
      sortDir: "asc",
    };

    function setHeaderTitle(){
      const t = state.tables[state.activeIdx];
      $("tableTitle").textContent = `${t.name} (ID ${t.id})`;
    }

    function setActive(idx){
      // persist inputs
      const prev = state.tables[state.activeIdx];
      prev.q = $("q").value || "";
      prev.pageSize = parseInt($("pageSize").value || "25", 10) || prev.pageSize;

      state.activeIdx = idx;
      state.sortKey = null;
      state.sortDir = "asc";

      $("tab1").classList.toggle("active", idx===0);
      $("tab2").classList.toggle("active", idx===1);

      const t = state.tables[idx];
      $("q").value = t.q || "";
      $("pageSize").value = String(t.pageSize || 25);

      // sidebar months only for tab2
      $("sidebar").classList.toggle("show", idx===1);
      // layout: when sidebar hidden, use one column to avoid "apiñada a la derecha"
      $("layout").classList.toggle("withSidebar", idx===1);
setHeaderTitle();
      renderMonths(); // update sidebar highlight
      render();
    }

    function buildMonths(){
      const t = state.tables[1];
      const rows = t.rows || [];
      if (!rows.length){ t.months = []; t.monthKey = null; return; }

      const keys = Object.keys(rows[0] || {}).filter(k => k !== "_row_id");
      // try best date/month key
      const key =
        findContains(keys, ["mes", "month"]) ||
        findContains(keys, ["fecha", "date"]) ||
        null;

      t.monthKey = key;

      const map = new Map(); // month -> count
      if (key){
        for (const r of rows){
          const m = parseMonth(r[key]);
          if (!m) continue;
          map.set(m, (map.get(m) || 0) + 1);
        }
      }
      // sorted descending
      t.months = [...map.entries()].sort((a,b) => b[0].localeCompare(a[0]));
    }

    function renderMonths(){
      const t = state.tables[1];
      const box = $("months");
      box.innerHTML = "";

      // If not in tab2, nothing
      if (state.activeIdx !== 1) return;

      // Always show ALL
      const mkBtn = (label, value, count=null) => {
        const div = document.createElement("div");
        div.className = "month" + (t.monthSelected === value ? " active" : "");
        div.innerHTML = `<span>${label}</span>${count!==null ? `<small>${count}</small>` : `<small> </small>`}`;
        div.onclick = () => {
          t.monthSelected = value;
          t.page = 1;
          renderMonths();
          render();
        };
        box.appendChild(div);
      };

      const total = (t.rows || []).length;
      mkBtn("Todos", "ALL", total);

      if (!t.monthKey || !t.months.length){
        const note = document.createElement("div");
        note.style.color = "var(--muted)";
        note.style.fontSize = "12px";
        note.style.marginTop = "8px";
        note.textContent = "No pude detectar una columna de fecha/mes para agrupar.";
        box.appendChild(note);
        return;
      }

      for (const [m, c] of t.months){
        // pretty label: YYYY-MM -> Mes YYYY
        const y = m.slice(0,4);
        const mm = m.slice(5,7);
        const nombres = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const lbl = `${nombres[parseInt(mm,10)-1] || mm} ${y}`;
        mkBtn(lbl, m, c);
      }
    }

    function getEffectiveRows(t){
      let rows = t.rows || [];

      // Month filter only for tab2
      if (state.activeIdx === 1 && t.monthSelected && t.monthSelected !== "ALL" && t.monthKey){
        rows = rows.filter(r => parseMonth(r[t.monthKey]) === t.monthSelected);
      }

      // Search filter
      const q = (t.q || "").trim().toLowerCase();
      if (q){
        rows = rows.filter(r =>
          Object.keys(r).some(k => (r[k] ?? "").toString().toLowerCase().includes(q))
        );
      }

      return rows;
    }

    function setStatsForVcc(){
      const t = state.tables[0];
      const rows = getEffectiveRows(t);
      if (!rows.length){
        $("s1k").textContent = "Entubación cecal";
        $("s1v").textContent = "—";
        $("s1s").textContent = "Sin filas para calcular";

        $("s2k").textContent = "VCC totales";
        $("s2v").textContent = "—";
        $("s2s").textContent = "—";

        $("s3k").textContent = "VCC con ciego alcanzado";
        $("s3v").textContent = "—";
        $("s3s").textContent = "—";
        return;
      }

      const keys = Object.keys(rows[0] || {});
      const keyProc = findKey(keys, ["procedure_type"]) || findContains(keys, ["procedure"]) || null;
      const keyCecal =
        findKey(keys, ["llego_a_ciego","cecal_intubation","entubacion_cecal","entubación_cecal"]) ||
        findContains(keys, ["ciego", "cecal"]) ||
        null;

      const isVccRow = (r) => {
        if (!keyProc) return true;
        const v = (r[keyProc] ?? "").toString().trim().toUpperCase();
        return v === "VCC";
      };

      const vccRows = rows.filter(isVccRow);
      const denom = vccRows.length;

      let num = 0;
      if (keyCecal){
        for (const r of vccRows){
          const b = guessBoolean(r[keyCecal]);
          if (b === true) num++;
        }
      }

      const pct = denom > 0 ? (num/denom*100) : 0;
      const frac = `${num.toLocaleString()} / ${denom.toLocaleString()}`;

      $("s1k").textContent = "Entubación cecal";
      $("s1v").textContent = keyCecal ? `${frac} (${pct.toFixed(1)}%)` : "—";
      $("s1s").textContent = keyCecal ? `Campo: ${keyCecal}${keyProc ? " • procedure_type=VCC" : ""}` : "No encontré campo de ciego.";

      $("s2k").textContent = "VCC totales";
      $("s2v").textContent = denom.toLocaleString();
      $("s2s").textContent = "Denominador";

      $("s3k").textContent = "VCC con ciego alcanzado";
      $("s3v").textContent = keyCecal ? num.toLocaleString() : "—";
      $("s3s").textContent = "Numerador";
    }

    function setStatsForByMonth(){
      const t = state.tables[1];
      const rows = getEffectiveRows(t);

      const total = rows.length;

      // detect keys (más tolerante)
      const keys = Object.keys(rows[0] || {});
      const keyProc =
        findKey(keys, ["procedure_type"]) ||
        findContains(keys, ["procedure", "proc", "tipo", "estudio"]) ||
        null;

      const keyTher =
        findKey(keys, ["terapeutica","terapéutica","therapeutica","therapeutic","therapeutics"]) ||
        findContains(keys, ["terapeut"]) ||
        null;

      // Si la tabla ya viene "agregada" (por ejemplo columnas tipo veda_sin, vcc_con, etc),
      // detectamos columnas numéricas y sumamos.
      const hasAgg =
        keys.some(k => k.toLowerCase().includes("veda")) &&
        keys.some(k => k.toLowerCase().includes("vcc")) &&
        (keys.some(k => k.toLowerCase().includes("sin")) || keys.some(k => k.toLowerCase().includes("con")));

      const sumNum = (arr, key) => arr.reduce((acc,r) => {
        const v = r[key];
        const n = Number(String(v ?? "").replace(",", "."));
        return acc + (Number.isFinite(n) ? n : 0);
      }, 0);

      // Defaults
      let vedaNo = 0, vccNo = 0, vedaYes = 0, vccYes = 0;
      let totalStudies = total;

      if (rows.length === 0){
        $("s1k").textContent = "Total de estudios";
        $("s1v").textContent = "—";
        $("s1s").textContent = "Sin filas para calcular";

        $("s2k").textContent = "VEDA / VCC (sin terapéutica)";
        $("s2v").textContent = "—";
        $("s2s").textContent = "—";

        $("s3k").textContent = "VEDA / VCC (con terapéutica)";
        $("s3v").textContent = "—";
        $("s3s").textContent = "—";
        return;
      }

      if (hasAgg){
        // Heurística: buscamos claves más probables
        const kVedaSin = keys.find(k => k.toLowerCase().includes("veda") && k.toLowerCase().includes("sin")) || null;
        const kVccSin  = keys.find(k => k.toLowerCase().includes("vcc")  && k.toLowerCase().includes("sin")) || null;
        const kVedaCon = keys.find(k => k.toLowerCase().includes("veda") && k.toLowerCase().includes("con")) || null;
        const kVccCon  = keys.find(k => k.toLowerCase().includes("vcc")  && k.toLowerCase().includes("con")) || null;

        vedaNo  = kVedaSin ? sumNum(rows, kVedaSin) : 0;
        vccNo   = kVccSin  ? sumNum(rows, kVccSin)  : 0;
        vedaYes = kVedaCon ? sumNum(rows, kVedaCon) : 0;
        vccYes  = kVccCon  ? sumNum(rows, kVccCon)  : 0;

        // total: si existe "total", lo usamos; si no, sumamos todo lo anterior
        const kTotal = keys.find(k => k.toLowerCase() === "total" || k.toLowerCase().includes("total_est")) || null;
        totalStudies = kTotal ? sumNum(rows, kTotal) : (vedaNo + vccNo + vedaYes + vccYes);
      } else {
        // Tabla "fila por estudio"
        const proc = (r) => (keyProc ? (r[keyProc] ?? "").toString().trim().toUpperCase() : "");
        const ther = (r) => (keyTher ? guessBoolean(r[keyTher]) : null);

        for (const r of rows){
          const p = proc(r);
          const th = ther(r);

          if (p === "VEDA"){
            if (th === true) vedaYes++;
            else vedaNo++; // null/false -> sin terapéutica (por ahora)
          } else if (p === "VCC"){
            if (th === true) vccYes++;
            else vccNo++;
          }
        }
        totalStudies = total;
      }

      $("s1k").textContent = "Total de estudios";
      $("s1v").textContent = totalStudies.toLocaleString();
      $("s1s").textContent = (t.monthSelected && t.monthSelected !== "ALL") ? `Mes: ${t.monthSelected}` : "Todos los meses";

      $("s2k").textContent = "VEDA / VCC (sin terapéutica)";
      $("s2v").textContent = `${vedaNo.toLocaleString()} / ${vccNo.toLocaleString()}`;
      $("s2s").textContent = keyTher || hasAgg ? "Sin terapéutica" : "No detecté columnas de procedimiento/terapéutica";

      $("s3k").textContent = "VEDA / VCC (con terapéutica)";
      $("s3v").textContent = `${vedaYes.toLocaleString()} / ${vccYes.toLocaleString()}`;
      $("s3s").textContent = keyTher || hasAgg ? "Con terapéutica" : "No detecté columnas de procedimiento/terapéutica";
    } else if (p === "VCC"){
          if (th === true) vccYes++;
          else vccNo++;
        }
      }

      $("s1k").textContent = "Total de estudios";
      $("s1v").textContent = total.toLocaleString();
      $("s1s").textContent = (t.monthSelected && t.monthSelected !== "ALL") ? `Mes: ${t.monthSelected}` : "Todos los meses";

      $("s2k").textContent = "VEDA / VCC (sin terapéutica)";
      $("s2v").textContent = `${vedaNo.toLocaleString()} / ${vccNo.toLocaleString()}`;
      $("s2s").textContent = keyTher ? "terapeutica = false/null" : "No detecté columna de terapéutica";

      $("s3k").textContent = "VEDA / VCC (con terapéutica)";
      $("s3v").textContent = `${vedaYes.toLocaleString()} / ${vccYes.toLocaleString()}`;
      $("s3s").textContent = keyTher ? "terapeutica = true" : "No detecté columna de terapéutica";
    }

    function updateStats(){
      if (state.activeIdx === 0) setStatsForVcc();
      else setStatsForByMonth();
    }

    function render(){
      const t = state.tables[state.activeIdx];
      const rows0 = getEffectiveRows(t);
      const cols0 = t.cols || [];
      const colNames = ["_row_id", ...cols0.map(c => c.title)].filter((v, i, a) => a.indexOf(v) === i);

      let rows = rows0;

      // sort
      if (state.sortKey){
        const k = state.sortKey;
        const dir = state.sortDir === "asc" ? 1 : -1;
        rows = [...rows].sort((a,b) => {
          const av = a[k] ?? "";
          const bv = b[k] ?? "";
          const an = Number(av), bn = Number(bv);
          const aNum = !Number.isNaN(an) && String(av).trim() !== "";
          const bNum = !Number.isNaN(bn) && String(bv).trim() !== "";
          if (aNum && bNum) return (an - bn) * dir;
          return String(av).localeCompare(String(bv), undefined, {numeric:true, sensitivity:"base"}) * dir;
        });
      }

      // paginate
      const ps = Math.max(1, t.pageSize|0);
      const total = rows.length;
      const maxPage = Math.max(1, Math.ceil(total / ps));
      t.page = Math.min(t.page, maxPage);
      const start = (t.page - 1) * ps;
      const pageRows = rows.slice(start, start + ps);

      const thead = $("thead");
      thead.innerHTML = "";
      const trh = document.createElement("tr");
      for (const c of colNames){
        const th = document.createElement("th");
        th.textContent = c === "_row_id" ? "row_id" : c;
        th.onclick = () => {
          if (state.sortKey === c){
            state.sortDir = (state.sortDir === "asc") ? "desc" : "asc";
          } else {
            state.sortKey = c;
            state.sortDir = "asc";
          }
          render();
        };
        trh.appendChild(th);
      }
      thead.appendChild(trh);

      const tbody = $("tbody");
      tbody.innerHTML = "";
      for (const r of pageRows){
        const tr = document.createElement("tr");
        for (const c of colNames){
          const td = document.createElement("td");
          td.textContent = (r[c] ?? "").toString();
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      $("meta").textContent =
        `${total.toLocaleString()} filas` +
        (t.q ? ` (filtradas por "${t.q}")` : "") +
        (state.activeIdx===1 && t.monthSelected!=="ALL" ? ` • mes: ${t.monthSelected}` : "") +
        (state.sortKey ? ` • orden: ${state.sortKey} (${state.sortDir})` : "");

      $("pageN").textContent = String(t.page);
      $("pageMax").textContent = String(maxPage);
      $("prev").disabled = t.page <= 1;
      $("next").disabled = t.page >= maxPage;

      $("debug").textContent = JSON.stringify(t.raw, null, 2);

      // alert if fetch failed
      const raw = t.raw || {};
      const okCols = raw.columns?.ok !== false;
      const okRows = raw.rows?.ok !== false;
      const hasRows = (t.rows || []).length > 0;
      const showAlert = (!okCols || !okRows) || (!hasRows && (raw.columns || raw.rows));
      const alert = $("alert");
      if (alert) alert.style.display = showAlert ? "block" : "none";

      updateStats();
    }

    async function loadAll(){
      try{
        for (let i=0;i<2;i++){
          const tid = state.tables[i].id;
          const baseUrl = CONFIG.baseUrl.replace(/\/+$/,"");

          const urlCols = `${baseUrl}/nc/tables/${tid}/columns`;
          const urlRows = `${baseUrl}/nc/tables/${tid}/rows`;

          const rCols = await fetchJson(urlCols);
          const rRows = await fetchJson(urlRows);

          state.tables[i].raw = {
            columns: { url: urlCols, ok: rCols.ok, status: rCols.status, json: rCols.json ?? rCols.text },
            rows:    { url: urlRows, ok: rRows.ok, status: rRows.status, json: rRows.json ?? rRows.text },
          };

          const cols = rCols.ok ? normalizeColumns(rCols.json) : [];
          const rows = rRows.ok ? normalizeRows(rRows.json, cols) : [];

          state.tables[i].cols = cols;
          state.tables[i].rows = rows;
        }

        buildMonths();
        renderMonths();
        setHeaderTitle();
        render();
      } catch (e){
        console.error(e);
        $("debug").textContent = "Error cargando datos. Mirá consola del navegador.";
      }
    }

    // UI handlers
    $("tab1").onclick = () => setActive(0);
    $("tab2").onclick = () => setActive(1);

    $("q").addEventListener("input", (e) => {
      const t = state.tables[state.activeIdx];
      t.q = e.target.value || "";
      t.page = 1;
      render();
    });

    $("pageSize").addEventListener("input", (e) => {
      const t = state.tables[state.activeIdx];
      const n = parseInt(e.target.value || "25", 10);
      t.pageSize = Number.isFinite(n) && n > 0 ? n : 25;
      t.page = 1;
      render();
    });

    $("prev").onclick = () => { const t=state.tables[state.activeIdx]; t.page = Math.max(1, t.page - 1); render(); };
    $("next").onclick = () => { const t=state.tables[state.activeIdx]; t.page = t.page + 1; render(); };

    // Init
    $("pageSize").value = "25";
    setActive(0);
    loadAll();
  </script>
</body>
</html>
