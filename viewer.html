<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EndoDB — Viewer</title>

  <!-- Inter (si falla, cae a system-ui) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#fff7ef;
      --bg1:#fffdf9;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e7ded4;
      --shadow: 0 10px 34px rgba(17,24,39,.10);

      --accent:#b45309;
      --accent2:#c2410c;
      --accentSoft:#fde6cf;
      --ok:#059669;
      --bad:#dc2626;
      --warn:#b45309;

      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 10% 10%, #ffe8d4 0%, transparent 55%),
        radial-gradient(900px 600px at 95% 0%, #fff1e4 0%, transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* Layout */
    .wrap{ max-width: 1180px; margin: 0 auto; padding: 18px; }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 14px;
    }

    .title{ margin:0; font-size: 20px; letter-spacing:.2px; }
    .subtitle{ margin-top: 6px; color:var(--muted); font-size: 13px; line-height:1.35; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      box-shadow: 0 4px 18px rgba(31,41,55,.06);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background: linear-gradient(135deg, var(--accent), var(--accent2)); }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      padding: 14px;
    }

    .cardHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .cardTitle{ font-weight: 800; font-size: 14px; }
    .cardHint{ color: var(--muted); font-size: 12px; line-height: 1.35; margin-top: 4px; }

    .kpis{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
    .kpi{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.9);
      box-shadow: 0 6px 18px rgba(31,41,55,.06);
      min-height: 74px;
    }
    .kpiLabel{ color:var(--muted); font-size: 12px; }
    .kpiValue{ font-size: 22px; font-weight: 900; margin-top: 4px; letter-spacing:.2px; }
    .kpiMeta{ color:var(--muted); font-size: 12px; margin-top: 4px; }

    /* Controls */
    .controls{ display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }

    label{ display:block; font-size:12px; color: var(--muted); margin: 0 0 6px 2px; }

    input, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      outline: none;
      font-size: 14px;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    input:focus, select:focus{
      border-color: rgba(180,83,9,.45);
      box-shadow: 0 0 0 4px rgba(180,83,9,.12);
    }

    .btn{
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      font-weight: 800;
      font-size: 13px;
      transition: transform .03s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 6px 18px rgba(31,41,55,.06);
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn:hover{ background: #fffaf4; }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .btn.primary{
      border-color: rgba(180,83,9,.35);
      background: linear-gradient(135deg, rgba(180,83,9,.92), rgba(194,65,12,.92));
      color: #fff;
    }

    .btn.ghost{ background: transparent; box-shadow:none; }

    .toggle{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
    }

    .toggle input{ width:auto; margin:0; }

    .muted{ color: var(--muted); }

    /* Table */
    .tableWrap{
      border-radius: 16px;
      border: 1px solid var(--line);
      overflow:hidden;
      background:#fff;
    }

    table{ width:100%; border-collapse: collapse; }

    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(180deg, rgba(253,230,207,.65), rgba(255,255,255,.92));
      border-bottom: 1px solid var(--line);
      font-size: 12px;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: .06em;
      padding: 10px 12px;
      text-align:left;
      white-space: nowrap;
    }

    tbody td{
      border-bottom: 1px solid rgba(231,222,212,.65);
      padding: 10px 12px;
      font-size: 13px;
      vertical-align: middle;
    }

    tbody tr{ cursor:pointer; }
    tbody tr:hover{ background: rgba(180,83,9,.05); }
    tbody tr.selected{ background: rgba(180,83,9,.10); }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.02);
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }
    .chip.ok{ border-color: rgba(5,150,105,.30); color: var(--ok); background: rgba(5,150,105,.08); }
    .chip.bad{ border-color: rgba(220,38,38,.30); color: var(--bad); background: rgba(220,38,38,.06); }
    .chip.warn{ border-color: rgba(180,83,9,.35); color: var(--warn); background: rgba(180,83,9,.08); }

    code{
      font-size: 12px;
      background: rgba(180,83,9,.10);
      padding: 2px 6px;
      border-radius: 10px;
    }

    .tabs{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .tab{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.9);
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
      color: #374151;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(180,83,9,.35);
      background: linear-gradient(135deg, rgba(180,83,9,.14), rgba(194,65,12,.10));
      color: #111827;
    }

    .divider{ border:none; border-top:1px solid rgba(231,222,212,.9); margin: 12px 0; }

    .empty{
      padding: 18px;
      border-radius: 16px;
      border: 1px dashed rgba(180,83,9,.35);
      background: linear-gradient(180deg, rgba(253,230,207,.52), rgba(255,255,255,.75));
      color: var(--muted);
      font-size: 13px;
      line-height:1.4;
    }

    .toast{
      position: fixed;
      left: 16px;
      bottom: 16px;
      max-width: min(520px, calc(100vw - 32px));
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.95);
      box-shadow: 0 20px 60px rgba(17,24,39,.18);
      display:none;
      gap: 10px;
      align-items:flex-start;
      z-index: 50;
    }
    .toast.show{ display:flex; }
    .toastTitle{ font-weight: 900; font-size: 13px; }
    .toastBody{ color: var(--muted); font-size: 12px; margin-top: 2px; line-height:1.35; }

    .icon{ width: 16px; height:16px; display:inline-block; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Responsive */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: 1fr; }
    }

    @media (max-width: 620px){
      .wrap{ padding: 14px; }
      .pill{ align-self:flex-start; }
      thead th:nth-child(4), tbody td:nth-child(4),
      thead th:nth-child(5), tbody td:nth-child(5),
      thead th:nth-child(6), tbody td:nth-child(6){ display:none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title">EndoDB — Viewer (VCC)</h1>
        <div class="subtitle">
          Lista + detalle en una sola pantalla. Cambiá el <span class="mono">API base</span> si movés el backend.
        </div>
      </div>
      <div class="pill"><span class="dot"></span> Modo lectura • Sin PHI</div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="kpiLabel">ADR</div>
        <div class="kpiValue" id="kpiAdr">—</div>
        <div class="kpiMeta" id="kpiAdrMeta">—</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">VCC válidas (en lista)</div>
        <div class="kpiValue" id="kpiValid">—</div>
        <div class="kpiMeta" id="kpiValidMeta">—</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">Registros mostrados</div>
        <div class="kpiValue" id="kpiShown">—</div>
        <div class="kpiMeta" id="kpiShownMeta">—</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: LIST -->
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="cardTitle">Lista de VCC</div>
            <div class="cardHint">Click en una fila para ver el detalle. Búsqueda por paciente o exam_id.</div>
          </div>
          <div class="controls">
            <button class="btn" id="btnExport" type="button" title="Exporta la lista mostrada a CSV">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10m0 0l-3-3m3 3l3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 14v4a3 3 0 003 3h10a3 3 0 003-3v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              </span>
              Exportar
            </button>
            <button class="btn primary" id="btnReload" type="button">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 10-2.343 5.657" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M20 7v5h-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </span>
              Recargar
            </button>
          </div>
        </div>

        <div class="controls" style="margin-bottom: 10px;">
          <div style="min-width: 240px; flex: 1;">
            <label for="apiBase">API base</label>
            <input id="apiBase" placeholder="https://mini-server.tailXXXXX.ts.net" />
          </div>

          <div style="min-width: 230px; flex: 1;">
            <label for="q">Buscar</label>
            <input id="q" placeholder="Paciente_001 o test-veda-001…" />
          </div>

          <div style="min-width: 200px;">
            <label for="limit">Límite</label>
            <select id="limit">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
            </select>
          </div>

          <div class="toggle" style="min-width: 280px;">
            <input id="validOnly" type="checkbox" />
            <div>
              <div style="font-weight:800; font-size: 13px;">Solo VCC válidas</div>
              <div class="muted" style="font-size:12px">Boston ≥ 6 y ciego</div>
            </div>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Paciente</th>
                <th>Boston</th>
                <th>Pólipos</th>
                <th>Terapéutica</th>
                <th>Adenoma</th>
                <th>Válida</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- rows -->
            </tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:10px; font-size:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div id="listMeta">—</div>
          <div class="mono" id="apiMeta">—</div>
        </div>
      </div>

      <!-- RIGHT: DETAIL -->
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="cardTitle">Detalle</div>
            <div class="cardHint" id="detailSub">Seleccioná un estudio.</div>
          </div>
          <div class="controls">
            <button class="btn" id="btnCopy" type="button" title="Copiar exam_id">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 9h10v12H9V9z" stroke="currentColor" stroke-width="2"/><path d="M5 15H4a1 1 0 01-1-1V4a1 1 0 011-1h10a1 1 0 011 1v1" stroke="currentColor" stroke-width="2"/></svg>
              </span>
              Copiar
            </button>
            <a id="pdfLink" href="#" target="_blank" style="text-decoration:none; display:none;">
              <button class="btn" type="button" title="Abrir PDF">
                <span class="icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V8l-5-6z" stroke="currentColor" stroke-width="2"/><path d="M14 2v6h6" stroke="currentColor" stroke-width="2"/></svg>
                </span>
                PDF
              </button>
            </a>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="summary">Resumen</div>
          <div class="tab" data-tab="fields">Campos</div>
          <div class="tab" data-tab="pdf">Vista PDF</div>
        </div>

        <div id="detailBody">
          <div class="empty">Elegí un registro a la izquierda. Si no aparece nada, revisá el <b>API base</b> y tocá <b>Recargar</b>.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="chip warn" id="toastBadge">Info</div>
    <div>
      <div class="toastTitle" id="toastTitle">—</div>
      <div class="toastBody" id="toastBody">—</div>
    </div>
  </div>

<script>
(() => {
  // --- Config
  const DEFAULT_API = "https://mini-server.tail577189.ts.net";

  // --- Elements
  const elApiBase = document.getElementById("apiBase");
  const elQ = document.getElementById("q");
  const elLimit = document.getElementById("limit");
  const elValidOnly = document.getElementById("validOnly");
  const elTbody = document.getElementById("tbody");
  const elListMeta = document.getElementById("listMeta");
  const elApiMeta = document.getElementById("apiMeta");
  const btnReload = document.getElementById("btnReload");
  const btnExport = document.getElementById("btnExport");
  const btnCopy = document.getElementById("btnCopy");
  const elPdfLink = document.getElementById("pdfLink");

  const kpiAdr = document.getElementById("kpiAdr");
  const kpiAdrMeta = document.getElementById("kpiAdrMeta");
  const kpiValid = document.getElementById("kpiValid");
  const kpiValidMeta = document.getElementById("kpiValidMeta");
  const kpiShown = document.getElementById("kpiShown");
  const kpiShownMeta = document.getElementById("kpiShownMeta");

  const elDetailSub = document.getElementById("detailSub");
  const elDetailBody = document.getElementById("detailBody");

  const toast = document.getElementById("toast");
  const toastBadge = document.getElementById("toastBadge");
  const toastTitle = document.getElementById("toastTitle");
  const toastBody = document.getElementById("toastBody");

  // --- State
  let API = loadSetting("endodb_api") || DEFAULT_API;
  let list = [];          // data.items
  let selectedExamId = null;
  let selectedRow = null;
  let selectedDetail = null; // full detail
  let activeTab = "summary";

  // --- Helpers
  function normApi(s){
    return (s || "").trim().replace(/\/+$/g, "");
  }

  function loadSetting(k){
    try { return localStorage.getItem(k); } catch { return null; }
  }

  function saveSetting(k,v){
    try { localStorage.setItem(k, v); } catch {}
  }

  function fmtDate(iso){
    if (!iso) return "—";
    const d = new Date(iso);
    return d.toLocaleString("es-AR");
  }

  function pct(n){
    if (n == null || Number.isNaN(n)) return "—";
    // si ya viene como % (ej: 27.3)
    return `${Number(n).toFixed(1)}%`;
  }

  function chip(kind, text){
    const span = document.createElement("span");
    span.className = `chip ${kind || ""}`;
    span.textContent = text;
    return span;
  }

  function escapeHtml(str){
    return (str ?? "").toString().replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function showToast(level, title, body){
    toastBadge.className = `chip ${level === "ok" ? "ok" : level === "bad" ? "bad" : "warn"}`;
    toastBadge.textContent = level === "ok" ? "OK" : level === "bad" ? "Error" : "Info";
    toastTitle.textContent = title;
    toastBody.textContent = body;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.classList.remove("show"), 3400);
  }

async function fetchJSON(url){
  const r = await fetch(url, { method: "GET" });
  if(!r.ok){
    const txt = await r.text().catch(() => "");
    throw new Error(`HTTP ${r.status}${txt ? " - " + txt.slice(0,120) : ""}`);
  }
  return await r.json();
}

// Devuelve el primer valor definido (no null/undefined) de una lista de claves en un objeto
function pick(obj, ...keys){
  for (const k of keys){
    if (obj && Object.prototype.hasOwnProperty.call(obj, k)) {
      const v = obj[k];
      if (v !== undefined && v !== null) return v;
    }
  }
  return undefined;
}

// Busca un campo en modelo EAV: [{field_name, value_json, ...}]
function fieldVal(fields, ...names){
  if (!Array.isArray(fields)) return undefined;
  for (const name of names){
    const f = fields.find(x => x && x.field_name === name);
    if (f && f.value_json !== undefined && f.value_json !== null) return f.value_json;
  }
  return undefined;
}

// Intento en cascada: devuelve el primer JSON que responda OK
async function tryFetchAny(urls){
  let lastErr = null;
  for (const url of urls){
    try {
      return await fetchJSON(url);
    } catch (e) {
      lastErr = e;
    }
  }
  throw lastErr || new Error("No se pudo obtener respuesta de ningún endpoint.");
}

// Normaliza respuestas heterogéneas del backend a: { summary, fields, files }
function normalizeDetail(raw){
  // Caso A: el endpoint ya devuelve el array de fields
  if (Array.isArray(raw)){
    return { summary: {}, fields: raw, files: [] };
  }
  // Caso B: objeto (puede traer summary/fields/files o solo summary)
  const out = {
    summary: raw?.summary ?? raw ?? {},
    fields: raw?.fields ?? [],
    files: raw?.files ?? []
  };
  // Si fields viene envuelto
  if (!Array.isArray(out.fields)){
    out.fields = out.fields?.items ?? [];
  }
  if (!Array.isArray(out.files)){
    out.files = out.files?.items ?? [];
  }
  return out;
}

// Construye un resumen "UI-friendly" usando sinónimos (incluye tus claves en español)
function buildSummary(summary, fields){
