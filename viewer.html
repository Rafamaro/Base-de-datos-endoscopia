<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nextcloud Tables Viewer • EndoDB</title>

  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0f1a2e;
      --card:#101c33;
      --ink:#e7eefc;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.10);
      --ok:#36d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#60a5fa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(167,139,250,.18), transparent 65%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .top{
      display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;
      margin-bottom:16px;
    }
    .brand{
      flex:1 1 320px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px 16px;
      box-shadow: var(--shadow);
      min-width: 280px;
    }
    .brand h1{margin:0 0 6px;font-size:18px;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .card{
      flex:2 1 520px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      min-width: 320px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr 0.7fr 0.7fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr 1fr}
    }
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input, select{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,18,34,.65);
      color:var(--ink);
      padding:10px 10px;
      outline:none;
    }
    input::placeholder{color:rgba(233,238,252,.45)}
    .row{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(96,165,250,.25), rgba(96,165,250,.12));
      color:var(--ink);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{ background: linear-gradient(180deg, rgba(167,139,250,.18), rgba(167,139,250,.08)); }
    .btn.ghost{ background: transparent; }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}

    .tabs{ display:flex;gap:10px;flex-wrap:wrap; margin:16px 0 10px; }
    .tab{
      padding:10px 12px;border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.15);
      cursor:pointer;color: var(--muted);user-select:none;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(96,165,250,.25), rgba(96,165,250,.10));
      color: var(--ink);
      border-color: rgba(96,165,250,.35);
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .panel-head{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;
      margin-bottom:10px;
    }
    .panel-head h2{margin:0;font-size:14px}
    .tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .tools input{width:260px;max-width:100%}
    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
    }
    thead th{
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:12px;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky; top:0;
      cursor:pointer; user-select:none; white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      font-size:13px;
      vertical-align:top;
      background: rgba(0,0,0,.10);
    }
    tbody tr:hover td{background: rgba(96,165,250,.10)}
    .footer{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-top:10px;color:var(--muted);font-size:12px;
    }
    .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pager button{
      padding:7px 10px;border-radius: 10px;border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.15); color:var(--ink); cursor:pointer;
    }
    .pager button:disabled{opacity:.55;cursor:not-allowed}
    details{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background: rgba(0,0,0,.12);
      padding:10px 12px;
    }
    summary{cursor:pointer;color:var(--muted);font-weight:600}
    pre{
      margin:10px 0 0;
      background: rgba(0,0,0,.30);
      padding:10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      overflow:auto;
      max-height: 320px;
      font-size:12px;
      line-height:1.35;
    }
    .tiny{font-size:12px}
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .check{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      color:var(--muted);
    }
    .check input{width:auto}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Viewer • Nextcloud Tables</h1>
        <p>
          Modo cómodo: recuerda URL/usuario/tablas y puede recordar la App Password (sesión o persistente).
          Si algo falla, abrí <b>Debug</b> abajo para ver la respuesta cruda.
        </p>
      </div>

      <div class="card">
        <div class="grid">
          <div style="grid-column: 1 / -1">
            <label>Base URL (sin barra final)</label>
            <input id="baseUrl" placeholder="https://nextcloud.drperez86.com" />
          </div>
          <div>
            <label>Usuario</label>
            <input id="user" placeholder="tu_usuario" autocomplete="username" />
          </div>
          <div>
            <label>App Password</label>
            <input id="pass" placeholder="**** (App password)" type="password" autocomplete="current-password" />
          </div>
          <div>
            <label>Table ID #1</label>
            <input id="t1" />
          </div>
          <div>
            <label>Table ID #2</label>
            <input id="t2" />
          </div>
        </div>

        <div class="row">
          <div class="inline tiny">
            <span class="check" title="Se borra al cerrar el navegador (recomendado).">
              <input type="radio" name="saveMode" id="saveSess" value="session" checked />
              <label for="saveSess" style="margin:0;">Guardar clave: sesión</label>
            </span>

            <span class="check" title="Queda guardada (más cómodo, menos seguro).">
              <input type="radio" name="saveMode" id="saveLocal" value="local" />
              <label for="saveLocal" style="margin:0;">Guardar clave: permanente</label>
            </span>

            <span class="check" title="No guarda la App Password, solo URL/usuario/tablas.">
              <input type="checkbox" id="dontSavePass" />
              <label for="dontSavePass" style="margin:0;">No guardar clave</label>
            </span>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnLoad">Cargar</button>
          <button class="btn secondary" id="btnReload" disabled>Recargar</button>
          <button class="btn ghost" id="btnExport" disabled>Export CSV</button>
          <button class="btn ghost" id="btnForget">Olvidar credenciales</button>

          <span class="pill" id="statusPill">
            <span class="dot warn"></span>
            <span id="statusText">Sin conectar</span>
          </span>

          <span class="pill mono" id="apiHint">API: /apps/tables/api/1</span>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab1">Tabla 1</div>
      <div class="tab" id="tab2">Tabla 2</div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <h2 id="tableTitle">—</h2>
        <div class="tools">
          <input id="q" placeholder="Buscar…" />
          <select id="pageSize">
            <option value="10">10 / pág</option>
            <option value="25" selected>25 / pág</option>
            <option value="50">50 / pág</option>
            <option value="100">100 / pág</option>
          </select>
        </div>
      </div>

      <div style="overflow:auto; max-height: 62vh; border-radius:14px;">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div id="meta" class="muted">—</div>
        <div class="pager">
          <button id="prev">◀</button>
          <span class="muted">Pág <span id="pageN">1</span> / <span id="pageMax">1</span></span>
          <button id="next">▶</button>
        </div>
      </div>

      <details>
        <summary>Debug (respuesta cruda de la API)</summary>
        <pre id="debug">(vacío)</pre>
      </details>
    </div>
  </div>

  <script>
    // =========================
    // Storage keys
    // =========================
    const KEY = {
      baseUrl: "nc_viewer_baseUrl",
      user: "nc_viewer_user",
      t1: "nc_viewer_t1",
      t2: "nc_viewer_t2",
      saveMode: "nc_viewer_saveMode",        // "session" | "local"
      dontSavePass: "nc_viewer_dontSavePass",// "1" | "0"
      passLocal: "nc_viewer_pass_local",
      passSession: "nc_viewer_pass_session",
    };

    // =========================
    // Helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function setStatus(kind, text){
      const pill = $("statusPill");
      const dot = pill.querySelector(".dot");
      dot.className = "dot " + (kind || "warn");
      $("statusText").textContent = text;
    }

    function b64Basic(user, pass){
      return "Basic " + btoa(`${user}:${pass}`);
    }

    async function fetchJson(url, user, pass){
      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Accept": "application/json",
          "OCS-APIRequest": "true",
          "Authorization": b64Basic(user, pass),
        },
        credentials: "omit",
      });

      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch(e){ /* no-op */ }

      return { ok: res.ok, status: res.status, text, json };
    }

    function toCsv(rows, columns){
      const esc = (v) => {
        if (v === null || v === undefined) return "";
        const s = String(v).replaceAll('"','""');
        return `"${s}"`;
      };
      const header = columns.map(c => esc(c)).join(",");
      const lines = rows.map(r => columns.map(c => esc(r[c])).join(","));
      return [header, ...lines].join("\n");
    }

    function downloadText(filename, content, mime="text/plain"){
      const blob = new Blob([content], {type:mime});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    // =========================
    // Nextcloud Tables parsing
    // =========================
    function normalizeColumns(colsJson){
      if (Array.isArray(colsJson)) return colsJson.map(c => ({
        id: c.id ?? c.columnId ?? c._id ?? c,
        title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
      }));
      if (colsJson && Array.isArray(colsJson.data)) return colsJson.data.map(c => ({
        id: c.id ?? c.columnId ?? c._id ?? c,
        title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
      }));
      return [];
    }

    function normalizeRows(rowsJson, cols){
      const colById = new Map(cols.map(c => [String(c.id), c.title]));
      const unwrap = (x) => {
        if (Array.isArray(x)) return x;
        if (x && Array.isArray(x.data)) return x.data;
        return [];
      };
      const rowsArr = unwrap(rowsJson);
      const out = [];
      for (const r of rowsArr){
        const obj = {};
        obj["_row_id"] = r.id ?? r.rowId ?? r._id ?? "";
        const cells = r.data ?? r.values ?? r.cells ?? [];
        if (Array.isArray(cells)){
          for (const cell of cells){
            const cid = String(cell.columnId ?? cell.id ?? "");
            const key = colById.get(cid) || (cid ? `col_${cid}` : "col");
            obj[key] = cell.value ?? cell.value_json ?? cell.displayValue ?? cell.text ?? "";
          }
        }
        out.push(obj);
      }
      return out;
    }

    // =========================
    // UI state
    // =========================
    const state = {
      activeIdx: 0,
      tables: [
        { id: 2, name: "Tabla 1", cols: [], rows: [], raw: {} },
        { id: 3, name: "Tabla 2", cols: [], rows: [], raw: {} },
      ],
      sortKey: null,
      sortDir: "asc",
      q: "",
      page: 1,
      pageSize: 25,
    };

    function setActive(idx){
      state.activeIdx = idx;
      state.sortKey = null;
      state.sortDir = "asc";
      state.page = 1;
      $("tab1").classList.toggle("active", idx===0);
      $("tab2").classList.toggle("active", idx===1);
      $("tableTitle").textContent = state.tables[idx].name + " (ID " + state.tables[idx].id + ")";
      render();
    }

    function render(){
      const t = state.tables[state.activeIdx];
      const rows0 = t.rows || [];
      const cols0 = t.cols || [];
      const colNames = ["_row_id", ...cols0.map(c => c.title)].filter((v, i, a) => a.indexOf(v) === i);

      const q = (state.q || "").trim().toLowerCase();
      let rows = rows0;
      if (q){
        rows = rows0.filter(r => {
          for (const k of Object.keys(r)){
            const v = r[k];
            if (v === null || v === undefined) continue;
            if (String(v).toLowerCase().includes(q)) return true;
          }
          return false;
        });
      }

      if (state.sortKey){
        const k = state.sortKey;
        const dir = state.sortDir === "asc" ? 1 : -1;
        rows = [...rows].sort((a,b) => {
          const av = a[k] ?? "";
          const bv = b[k] ?? "";
          const an = Number(av), bn = Number(bv);
          const aNum = !Number.isNaN(an) && String(av).trim() !== "";
          const bNum = !Number.isNaN(bn) && String(bv).trim() !== "";
          if (aNum && bNum) return (an - bn) * dir;
          return String(av).localeCompare(String(bv), undefined, {numeric:true, sensitivity:"base"}) * dir;
        });
      }

      const ps = state.pageSize;
      const total = rows.length;
      const maxPage = Math.max(1, Math.ceil(total / ps));
      state.page = Math.min(state.page, maxPage);
      const start = (state.page - 1) * ps;
      const pageRows = rows.slice(start, start + ps);

      const thead = $("thead");
      thead.innerHTML = "";
      const trh = document.createElement("tr");
      for (const c of colNames){
        const th = document.createElement("th");
        th.textContent = c === "_row_id" ? "row_id" : c;
        th.title = "Click para ordenar";
        th.onclick = () => {
          if (state.sortKey === c){
            state.sortDir = (state.sortDir === "asc") ? "desc" : "asc";
          } else {
            state.sortKey = c;
            state.sortDir = "asc";
          }
          render();
        };
        trh.appendChild(th);
      }
      thead.appendChild(trh);

      const tbody = $("tbody");
      tbody.innerHTML = "";
      for (const r of pageRows){
        const tr = document.createElement("tr");
        for (const c of colNames){
          const td = document.createElement("td");
          const v = r[c];
          td.textContent = (v === null || v === undefined) ? "" : String(v);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      $("meta").textContent =
        `${total.toLocaleString()} filas` +
        (q ? ` (filtradas por "${state.q}")` : "") +
        (state.sortKey ? ` • orden: ${state.sortKey} (${state.sortDir})` : "");

      $("pageN").textContent = String(state.page);
      $("pageMax").textContent = String(maxPage);
      $("prev").disabled = state.page <= 1;
      $("next").disabled = state.page >= maxPage;

      $("debug").textContent = JSON.stringify(t.raw, null, 2);
    }

    // =========================
    // Save/Load settings
    // =========================
    function getSaveMode(){
      return localStorage.getItem(KEY.saveMode) || "session";
    }

    function getDontSavePass(){
      return (localStorage.getItem(KEY.dontSavePass) || "0") === "1";
    }

    function setSaveMode(mode){
      localStorage.setItem(KEY.saveMode, mode);
      $("saveSess").checked = mode === "session";
      $("saveLocal").checked = mode === "local";
    }

    function setDontSavePass(flag){
      localStorage.setItem(KEY.dontSavePass, flag ? "1" : "0");
      $("dontSavePass").checked = flag;
      // si activa "no guardar", borramos lo guardado para que sea coherente
      if (flag){
        localStorage.removeItem(KEY.passLocal);
        sessionStorage.removeItem(KEY.passSession);
      }
    }

    function saveSettings(){
      const baseUrl = $("baseUrl").value.trim();
      const user = $("user").value.trim();
      const t1 = $("t1").value.trim();
      const t2 = $("t2").value.trim();

      localStorage.setItem(KEY.baseUrl, baseUrl);
      localStorage.setItem(KEY.user, user);
      localStorage.setItem(KEY.t1, t1);
      localStorage.setItem(KEY.t2, t2);

      const mode = $("saveLocal").checked ? "local" : "session";
      setSaveMode(mode);

      const dontSave = $("dontSavePass").checked;
      setDontSavePass(dontSave);

      if (!dontSave){
        const pass = $("pass").value;
        if (mode === "local"){
          localStorage.setItem(KEY.passLocal, pass);
          sessionStorage.removeItem(KEY.passSession);
        } else {
          sessionStorage.setItem(KEY.passSession, pass);
          localStorage.removeItem(KEY.passLocal);
        }
      }
    }

    function loadSettings(){
      const baseUrl = localStorage.getItem(KEY.baseUrl) || "https://nextcloud.drperez86.com";
      const user = localStorage.getItem(KEY.user) || "";
      const t1 = localStorage.getItem(KEY.t1) || "2";
      const t2 = localStorage.getItem(KEY.t2) || "3";

      $("baseUrl").value = baseUrl;
      $("user").value = user;
      $("t1").value = t1;
      $("t2").value = t2;

      const mode = getSaveMode();
      setSaveMode(mode);

      const dontSave = getDontSavePass();
      setDontSavePass(dontSave);

      if (!dontSave){
        const pass = (mode === "local")
          ? (localStorage.getItem(KEY.passLocal) || "")
          : (sessionStorage.getItem(KEY.passSession) || "");
        $("pass").value = pass;
      } else {
        $("pass").value = "";
      }
    }

    function forgetAll(){
      localStorage.removeItem(KEY.baseUrl);
      localStorage.removeItem(KEY.user);
      localStorage.removeItem(KEY.t1);
      localStorage.removeItem(KEY.t2);
      localStorage.removeItem(KEY.saveMode);
      localStorage.removeItem(KEY.dontSavePass);
      localStorage.removeItem(KEY.passLocal);
      sessionStorage.removeItem(KEY.passSession);

      $("pass").value = "";
      loadSettings();
      setStatus("warn", "Credenciales olvidadas");
    }

    // =========================
    // Load tables
    // =========================
    async function loadAll(){
      saveSettings(); // guardamos lo que está en pantalla (modo cómodo)

      const baseUrl = $("baseUrl").value.trim().replace(/\/+$/,"");
      const user = $("user").value.trim();
      const pass = $("pass").value;

      if (!baseUrl || !user || !pass){
        setStatus("warn", "Faltan credenciales");
        return;
      }

      setStatus("warn", "Cargando…");
      $("btnLoad").disabled = true;
      $("btnReload").disabled = true;
      $("btnExport").disabled = true;

      state.tables[0].id = Number($("t1").value.trim()) || 2;
      state.tables[1].id = Number($("t2").value.trim()) || 3;
      state.tables[0].name = `Tabla 1`;
      state.tables[1].name = `Tabla 2`;

      // Tabs titles
      $("tab1").textContent = `Tabla ${state.tables[0].id}`;
      $("tab2").textContent = `Tabla ${state.tables[1].id}`;

      try{
        for (let i=0;i<2;i++){
          const tid = state.tables[i].id;

          const urlCols = `${baseUrl}/apps/tables/api/1/tables/${tid}/columns`;
          const urlRows = `${baseUrl}/apps/tables/api/1/tables/${tid}/rows`;

          const rCols = await fetchJson(urlCols, user, pass);
          const rRows = await fetchJson(urlRows, user, pass);

          state.tables[i].raw = {
            columns: { url: urlCols, ok: rCols.ok, status: rCols.status, json: rCols.json ?? rCols.text },
            rows:    { url: urlRows, ok: rRows.ok, status: rRows.status, json: rRows.json ?? rRows.text },
          };

          const cols = rCols.ok ? normalizeColumns(rCols.json) : [];
          const rows = rRows.ok ? normalizeRows(rRows.json, cols) : [];

          state.tables[i].cols = cols;
          state.tables[i].rows = rows;
        }

        const okAny = state.tables.some(t => (t.rows?.length || 0) > 0);
        if (okAny){
          setStatus("ok", "Conectado");
        } else {
          setStatus("warn", "Conectó pero sin filas (mirá Debug)");
        }

        $("btnReload").disabled = false;
        $("btnExport").disabled = false;

        $("tableTitle").textContent = state.tables[state.activeIdx].name + " (ID " + state.tables[state.activeIdx].id + ")";
        render();

      } catch(err){
        console.error(err);
        setStatus("bad", "Error al cargar (ver consola)");
      } finally {
        $("btnLoad").disabled = false;
      }
    }

    // =========================
    // Wire UI
    // =========================
    $("tab1").onclick = () => setActive(0);
    $("tab2").onclick = () => setActive(1);

    $("btnLoad").onclick = loadAll;
    $("btnReload").onclick = loadAll;
    $("btnForget").onclick = forgetAll;

    // Persist on changes (sin cargar)
    ["baseUrl","user","pass","t1","t2"].forEach(id => {
      $(id).addEventListener("change", () => saveSettings());
      $(id).addEventListener("blur", () => saveSettings());
    });

    $("saveSess").addEventListener("change", () => saveSettings());
    $("saveLocal").addEventListener("change", () => saveSettings());
    $("dontSavePass").addEventListener("change", (e) => setDontSavePass(e.target.checked));

    $("q").addEventListener("input", (e) => {
      state.q = e.target.value || "";
      state.page = 1;
      render();
    });

    $("pageSize").addEventListener("change", (e) => {
      state.pageSize = Number(e.target.value) || 25;
      state.page = 1;
      render();
    });

    $("prev").onclick = () => { state.page = Math.max(1, state.page - 1); render(); };
    $("next").onclick = () => { state.page = state.page + 1; render(); };

    $("btnExport").onclick = () => {
      const t = state.tables[state.activeIdx];
      const cols = ["_row_id", ...(t.cols || []).map(c => c.title)].filter((v,i,a)=>a.indexOf(v)===i);
      const csv = toCsv(t.rows || [], cols);
      downloadText(`table_${t.id}.csv`, csv, "text/csv;charset=utf-8");
    };

    // =========================
    // Init
    // =========================
    loadSettings();
    setActive(0);

    // Si ya hay pass guardada, habilitamos recargar directo
    if ($("pass").value && $("user").value && $("baseUrl").value){
      $("btnReload").disabled = false;
    }
  </script>
</body>
</html>
