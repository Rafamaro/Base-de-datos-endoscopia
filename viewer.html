cat > /srv/endodb-viewer/index.html <<'HTML'
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EndoDB • Viewer (SQLite)</title>
  <style>
    :root { --bg:#0b1220; --card:#121b2e; --ink:#e7eefc; --mut:#9fb0d1; --line:#253252; --acc:#4aa3ff; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#0b1220,#070c16); color:var(--ink); }
    .wrap{ max-width:1100px; margin:0 auto; padding:20px; }
    h1{ font-size:18px; margin:0 0 14px; color:var(--ink); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, button{ border-radius:10px; border:1px solid var(--line); background:#0f172a; color:var(--ink); padding:10px 12px; }
    input{ flex:1; min-width:220px; }
    button{ cursor:pointer; }
    button:hover{ border-color:var(--acc); }
    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; margin-top:14px; }
    .card{ background:rgba(18,27,46,.85); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .mut{ color:var(--mut); font-size:12px; }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ padding:8px; border-bottom:1px solid var(--line); font-size:13px; }
    th{ text-align:left; color:var(--mut); font-weight:600; }
    tr:hover td{ background:rgba(74,163,255,.06); cursor:pointer; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px; color:var(--mut); }
    .actions a{ color:var(--acc); text-decoration:none; }
    .actions a:hover{ text-decoration:underline; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    pre{ white-space:pre-wrap; word-break:break-word; background:#0f172a; border:1px solid var(--line); padding:10px; border-radius:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>EndoDB • Viewer (leyendo SQLite)</h1>

    <div class="row">
      <input id="search" placeholder="Buscar por exam_id o patient_code..." />
      <button id="btnSearch">Buscar</button>
      <span class="mut" id="status"></span>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="mut">Exámenes</div>
          </div>
          <div class="row">
            <button id="prev">◀</button>
            <button id="next">▶</button>
          </div>
        </div>

        <table id="tbl">
          <thead>
            <tr>
              <th>exam_id</th>
              <th>patient_code</th>
              <th>procedure</th>
              <th>status</th>
              <th>created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div class="mut">Detalle</div>
        <div id="detail">
          <div class="mut">Seleccioná un examen.</div>
        </div>
      </div>
    </div>
  </div>

<script>
let offset = 0;
let limit = 20;

const el = (id)=>document.getElementById(id);
const status = (t)=>el("status").textContent=t;

async function fetchJSON(url){
  const r = await fetch(url);
  const j = await r.json();
  if(!r.ok) throw new Error(j.detail || "Error");
  return j;
}

function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

async function loadList(){
  const s = el("search").value.trim();
  status("cargando...");
  const data = await fetchJSON(`/api/exams?limit=${limit}&offset=${offset}&search=${encodeURIComponent(s)}`);
  const tb = el("tbl").querySelector("tbody");
  tb.innerHTML = "";
  for(const it of data.items){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(it.exam_id)}</td>
      <td>${esc(it.patient_code)}</td>
      <td><span class="pill">${esc(it.procedure_type || "?")}</span></td>
      <td><span class="pill">${esc(it.status || "?")}</span></td>
      <td class="mut">${esc(it.created_at || "")}</td>
    `;
    tr.addEventListener("click", ()=>loadDetail(it.exam_id));
    tb.appendChild(tr);
  }
  status(`mostrando ${data.items.length} (offset ${offset})`);
}

async function loadDetail(exam_id){
  status("cargando detalle...");
  const ex = await fetchJSON(`/api/exams/${encodeURIComponent(exam_id)}`);
  const fields = await fetchJSON(`/api/exams/${encodeURIComponent(exam_id)}/fields`);
  const files = await fetchJSON(`/api/exams/${encodeURIComponent(exam_id)}/files`);

  const rawPdf = (files.items || []).find(x => x.kind === "raw_pdf");
  const pdfLink = rawPdf ? `<div class="actions"><a target="_blank" href="/api/exams/${encodeURIComponent(exam_id)}/files/raw_pdf">Abrir PDF</a></div>` : `<div class="mut">No hay raw_pdf registrado</div>`;

  const fHtml = (fields.items||[]).map(x=>{
    return `<tr>
      <td>${esc(x.field_name)}</td>
      <td><pre>${esc(JSON.stringify(x.value_json, null, 2))}</pre></td>
      <td class="mut">${esc(x.confidence ?? "")}</td>
    </tr>`;
  }).join("");

  const filesHtml = (files.items||[]).slice(0,20).map(x=>{
    return `<tr>
      <td>${esc(x.kind)}</td>
      <td class="mut">${esc(x.path||"")}</td>
    </tr>`;
  }).join("");

  el("detail").innerHTML = `
    <div><b>${esc(ex.exam_id)}</b></div>
    <div class="mut">${esc(ex.patient_code)} • <span class="pill">${esc(ex.procedure_type || "?")}</span> • <span class="pill">${esc(ex.status || "?")}</span></div>
    <div class="mut" style="margin-top:8px;">${esc(ex.created_at||"")}</div>
    <div style="margin-top:10px;">${pdfLink}</div>

    <hr style="border:0;border-top:1px solid var(--line); margin:12px 0;">

    <div class="mut">Campos (fields)</div>
    <table>
      <thead><tr><th>field</th><th>value_json</th><th>conf</th></tr></thead>
      <tbody>${fHtml || `<tr><td colspan="3" class="mut">Sin campos</td></tr>`}</tbody>
    </table>

    <hr style="border:0;border-top:1px solid var(--line); margin:12px 0;">

    <div class="mut">Archivos (primeros 20)</div>
    <table>
      <thead><tr><th>kind</th><th>path</th></tr></thead>
      <tbody>${filesHtml || `<tr><td colspan="2" class="mut">Sin archivos</td></tr>`}</tbody>
    </table>
  `;
  status("ok");
}

el("btnSearch").addEventListener("click", ()=>{ offset=0; loadList(); });
el("search").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ offset=0; loadList(); }});
el("prev").addEventListener("click", ()=>{ offset=Math.max(0, offset-limit); loadList(); });
el("next").addEventListener("click", ()=>{ offset=offset+limit; loadList(); });

loadList();
</script>
</body>
</html>
HTML
