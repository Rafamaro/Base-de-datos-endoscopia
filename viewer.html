<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Base de Datos Dr Perez • Viewer</title>

  <style>
    :root{
      --bg0:#f6f9ff;
      --bg1:#ffffff;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;

      --accent:#1d4ed8;      /* azul rey */
      --accent2:#1e40af;
      --accentSoft: rgba(29,78,216,.10);

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1100px 600px at 12% 0%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(900px 520px at 92% 8%, rgba(29,78,216,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--ink);
    }

    .wrap{max-width:1350px;margin:0 auto;padding:22px}

    /* Header */
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px 16px;
      box-shadow: var(--shadow);
    }
    .title{
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
      margin:0;
      line-height:1.15;
    }
    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
    }
    .brand-right{
      display:flex;align-items:center;gap:10px;
    }
    .logo{
      width:86px;height:86px;
      object-fit:cover;
      border-radius: 18px;
      border:1px solid rgba(29,78,216,.25);
      box-shadow: 0 10px 22px rgba(29,78,216,.18);
      background: #fff;
    }

    /* Stats row */
    .stats{
      width:100%;
      display:grid;
      grid-template-columns: 1.2fr 0.8fr 0.8fr;
      gap:10px;
      margin:14px 0 14px;
    }
    @media (max-width: 980px){
      .stats{grid-template-columns:1fr}
    }
    .stat{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(29,78,216,.06), rgba(255,255,255,1));
      border-radius: 16px;
      padding:12px;
      min-height: 74px;
    }
    .stat .k{font-size:12px;color:var(--muted);margin-bottom:6px}
    .stat .v{font-size:16px;font-weight:900;letter-spacing:.2px}
    .stat .s{font-size:12px;color:var(--muted);margin-top:4px}

    /* Tabs */
    .tabs{ display:flex;gap:10px;flex-wrap:wrap; margin:0 0 10px; }
    .tab{
      padding:10px 12px;border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      cursor:pointer;color: var(--muted);user-select:none;
      font-weight:900;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(29,78,216,.18), rgba(29,78,216,.06));
      color: var(--ink);
      border-color: rgba(29,78,216,.30);
    }

    /* Layout for table view + month sidebar */
    .layout{ display:block; }
    .layout.withSidebar{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout.withSidebar{grid-template-columns:1fr}
    }

    .sidebar{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
      height: calc(62vh + 90px);
      overflow:auto;
      display:none;
    }
    .sidebar.show{display:block}
    .side-title{
      margin:0 0 10px;
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .month{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      margin-bottom:8px;
      font-weight:900;
      color: var(--ink);
    }
    .month small{color: var(--muted); font-weight:800}
    .month.active{
      border-color: rgba(29,78,216,.35);
      background: linear-gradient(180deg, rgba(29,78,216,.16), rgba(29,78,216,.06));
    }

    /* Panel + table */
    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .panel-head{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;
      margin-bottom:10px;
    }
    .panel-head h2{margin:0;font-size:14px}
    .tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input{
      border-radius: 12px;
      border:1px solid var(--line);
      background: #fff;
      color:var(--ink);
      padding:10px 10px;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
      width:260px; max-width:100%;
    }
    input:focus{
      border-color: rgba(29,78,216,.55);
      box-shadow: 0 0 0 4px rgba(29,78,216,.12);
    }
    input.small{width:120px}
    input::placeholder{color:rgba(71,85,105,.55)}

    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius: 14px;
      border:1px solid var(--line);
    }
    thead th{
      background: rgba(15,23,42,.02);
      color: var(--muted);
      font-size:12px;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      cursor:pointer; user-select:none; white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(226,232,240,.85);
      font-size:13px;
      vertical-align:top;
      background: #fff;
    }
    tbody tr:hover td{background: rgba(29,78,216,.06)}

    .footer{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-top:10px;color:var(--muted);font-size:12px;
    }
    .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pager button{
      padding:7px 10px;border-radius: 10px;border:1px solid var(--line);
      background: rgba(255,255,255,.85); color:var(--ink); cursor:pointer;
      font-weight:900;
    }
    .pager button:disabled{opacity:.55;cursor:not-allowed}

    details{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(15,23,42,.02);
      padding:10px 12px;
    }
    summary{cursor:pointer;color:var(--muted);font-weight:900}
    pre{
      margin:10px 0 0;
      background: rgba(15,23,42,.04);
      padding:10px;
      border-radius: 12px;
      border:1px solid var(--line);
      overflow:auto;
      max-height: 320px;
      font-size:12px;
      line-height:1.35;
      font-family: var(--mono);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="title">Base de Datos Dr Perez</h1>
        <p class="subtitle">Viewer de tablas (VCC y estadísticas por mes).</p>
      </div>
      <div class="brand-right">
        <img class="logo"
             alt="Logo"
             src="https://raw.githubusercontent.com/Rafamaro/Base-de-datos-endoscopia/main/WhatsApp%20Image%202026-02-03%20at%2022.23.15.jpeg">
      </div>
    </div>

    <!-- Stats (cambian según vista) -->
    <div class="stats">
      <div class="stat" id="s1">
        <div class="k" id="s1k">—</div>
        <div class="v" id="s1v">—</div>
        <div class="s" id="s1s">—</div>
      </div>
      <div class="stat" id="s2">
        <div class="k" id="s2k">—</div>
        <div class="v" id="s2v">—</div>
        <div class="s" id="s2s">—</div>
      </div>
      <div class="stat" id="s3">
        <div class="k" id="s3k">—</div>
        <div class="v" id="s3v">—</div>
        <div class="s" id="s3s">—</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab1">Base de datos de VCC</div>
      <div class="tab" id="tab2">Estudios por mes</div>
      <div style="flex:1"></div>
      <button class="btn secondary" id="btnRefresh" style="height:40px">Actualizar</button>
      <span class="pill" id="statusPill" style="height:40px">
        <span class="dot warn"></span>
        <span id="statusText">Sin cargar</span>
      </span>
    </div>

    <div class="layout" id="layout">
      <!-- sidebar months -->
      <div class="sidebar" id="sidebar">
        <div class="side-title">Meses</div>
        <div id="months"></div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <h2 id="tableTitle">—</h2>
          <div class="tools">
            <input id="q" placeholder="Buscar en esta tabla…" />
            <input id="pageSize" class="small" placeholder="25" title="Filas por página" />
          </div>
        </div>

        <div style="overflow:auto; max-height: 62vh; border-radius:14px;">
          <table>
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="footer">
          <div id="meta">—</div>
          <div class="pager">
            <button id="prev">◀</button>
            <span>Pág <span id="pageN">1</span> / <span id="pageMax">1</span></span>
            <button id="next">▶</button>
          </div>
        </div>

        <details>
          <summary>Debug</summary>
          <pre id="debug">(vacío)</pre>
        </details>
      </div>
    </div>
  </div>

  <!-- Hidden stats loader (reusa stats.html) -->
  <iframe id="statsFrame" src="./stats.html" style="display:none" aria-hidden="true"></iframe>

  <script>
    const $ = (id) => document.getElementById(id);

    function setStatus(kind, text){
      const pill = $("statusPill");
      if (!pill) return;
      const dot = pill.querySelector(".dot");
      dot.className = "dot " + (kind || "warn");
      $("statusText").textContent = text;
    }


    // ✅ Hardcode (pediste borrar UI de configuración)
    const CONFIG = {
      baseUrl: "https://basededatos.corrongo182.workers.dev",
      tableVccId: 2,
      tableByMonthId: 3,
    };

    async function fetchJson(url){
      const res = await fetch(url, { method: "GET" });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch(e) {}
      return { ok: res.ok, status: res.status, text, json };
    }

    function normalizeColumns(colsJson){
      if (Array.isArray(colsJson)) return colsJson.map(c => ({
        id: c.id ?? c.columnId ?? c._id ?? c,
        title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
      }));
      if (colsJson && Array.isArray(colsJson.data)) return colsJson.data.map(c => ({
        id: c.id ?? c.columnId ?? c._id ?? c,
        title: c.title ?? c.name ?? c.label ?? String(c.id ?? c.columnId ?? c),
      }));
      return [];
    }

    function normalizeRows(rowsJson, cols){
      const colById = new Map(cols.map(c => [String(c.id), c.title]));
      const unwrap = (x) => Array.isArray(x) ? x : (x && Array.isArray(x.data) ? x.data : []);
      const rowsArr = unwrap(rowsJson);
      const out = [];
      for (const r of rowsArr){
        const obj = {};
        obj["_row_id"] = r.id ?? r.rowId ?? r._id ?? "";
        const cells = r.data ?? r.values ?? r.cells ?? [];
        if (Array.isArray(cells)){
          for (const cell of cells){
            const cid = String(cell.columnId ?? cell.id ?? "");
            const key = colById.get(cid) || (cid ? `col_${cid}` : "col");
            obj[key] = cell.value ?? cell.value_json ?? cell.displayValue ?? cell.text ?? "";
          }
        }
        out.push(obj);
      }
      return out;
    }

    function guessBoolean(v){
      if (typeof v === "boolean") return v;
      if (v === null || v === undefined) return null;
      const s = String(v).trim().toLowerCase();
      if (["true","1","si","sí","y","yes"].includes(s)) return true;
      if (["false","0","no","n"].includes(s)) return false;
      return null;
    }

    function findKey(keys, wanted){
      const low = keys.map(k => [k, k.toLowerCase()]);
      for (const w of wanted){
        const wl = w.toLowerCase();
        const exact = low.find(([k, kl]) => kl === wl);
        if (exact) return exact[0];
      }
      return null;
    }

    function findContains(keys, substrs){
      const low = keys.map(k => [k, k.toLowerCase()]);
      for (const s of substrs){
        const sl = s.toLowerCase();
        const hit = low.find(([k, kl]) => kl.includes(sl));
        if (hit) return hit[0];
      }
      return null;
    }

    function parseMonth(value){
      if (value === null || value === undefined) return null;
      const s = String(value).trim();
      if (!s) return null;

      // If already like YYYY-MM
      const m1 = s.match(/^(\d{4})[-/](\d{1,2})/);
      if (m1){
        const y = m1[1];
        const mm = String(Math.max(1, Math.min(12, parseInt(m1[2],10)))).padStart(2,"0");
        return `${y}-${mm}`;
      }

      // Try Date parsing
      const d = new Date(s);
      if (!Number.isNaN(d.getTime())){
        const y = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        return `${y}-${mm}`;
      }

      // Try "MM/YYYY" or "MM-YYYY"
      const m2 = s.match(/^(\d{1,2})[-/](\d{4})$/);
      if (m2){
        const mm = String(Math.max(1, Math.min(12, parseInt(m2[1],10)))).padStart(2,"0");
        const y = m2[2];
        return `${y}-${mm}`;
      }

      return null;
    }

    const state = {
      activeIdx: 0,
      tables: [
        { id: CONFIG.tableVccId, name: "Base de datos de VCC", cols: [], rows: [], raw: {}, q:"", page:1, pageSize:25 },
        { id: CONFIG.tableByMonthId, name: "Estudios por mes", cols: [], rows: [], raw: {}, q:"", page:1, pageSize:25, monthKey: null, monthSelected: "ALL", months: [] },
      ],
      sortKey: null,
      sortDir: "asc",
    };

    function setHeaderTitle(){
      const t = state.tables[state.activeIdx];
      $("tableTitle").textContent = `${t.name} (ID ${t.id})`;
    }

    function setActive(idx){
      // persist inputs
      const prev = state.tables[state.activeIdx];
      prev.q = $("q").value || "";
      prev.pageSize = parseInt($("pageSize").value || "25", 10) || prev.pageSize;

      state.activeIdx = idx;
      state.sortKey = null;
      state.sortDir = "asc";

      $("tab1").classList.toggle("active", idx===0);
      $("tab2").classList.toggle("active", idx===1);

      const t = state.tables[idx];
      $("q").value = t.q || "";
      $("pageSize").value = String(t.pageSize || 25);

      // sidebar months only for tab2
      $("sidebar").classList.toggle("show", idx===1);
      $("layout").classList.toggle("withSidebar", idx===1);

      setHeaderTitle();
      renderMonths(); // update sidebar highlight
      render();
    }

    function buildMonths(){
      const t = state.tables[1];
      const rows = t.rows || [];
      if (!rows.length){ t.months = []; t.monthKey = null; return; }

      const keys = Object.keys(rows[0] || {}).filter(k => k !== "_row_id");
      // try best date/month key
      const key =
        findContains(keys, ["mes", "month"]) ||
        findContains(keys, ["fecha", "date"]) ||
        null;

      t.monthKey = key;

      const map = new Map(); // month -> count
      if (key){
        for (const r of rows){
          const m = parseMonth(r[key]);
          if (!m) continue;
          map.set(m, (map.get(m) || 0) + 1);
        }
      }
      // sorted descending
      t.months = [...map.entries()].sort((a,b) => b[0].localeCompare(a[0]));
    }

    function renderMonths(){
      const t = state.tables[1];
      const box = $("months");
      box.innerHTML = "";

      // If not in tab2, nothing
      if (state.activeIdx !== 1) return;

      // Always show ALL
      const mkBtn = (label, value, count=null) => {
        const div = document.createElement("div");
        div.className = "month" + (t.monthSelected === value ? " active" : "");
        div.innerHTML = `<span>${label}</span>${count!==null ? `<small>${count}</small>` : `<small> </small>`}`;
        div.onclick = () => {
          t.monthSelected = value;
          t.page = 1;
          renderMonths();
          render();
        };
        box.appendChild(div);
      };

      const total = (t.rows || []).length;
      mkBtn("Todos", "ALL", total);

      if (!t.monthKey || !t.months.length){
        const note = document.createElement("div");
        note.style.color = "var(--muted)";
        note.style.fontSize = "12px";
        note.style.marginTop = "8px";
        note.textContent = "No pude detectar una columna de fecha/mes para agrupar.";
        box.appendChild(note);
        return;
      }

      for (const [m, c] of t.months){
        // pretty label: YYYY-MM -> Mes YYYY
        const y = m.slice(0,4);
        const mm = m.slice(5,7);
        const nombres = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const lbl = `${nombres[parseInt(mm,10)-1] || mm} ${y}`;
        mkBtn(lbl, m, c);
      }
    }

    function getEffectiveRows(t){
      let rows = t.rows || [];

      // Month filter only for tab2
      if (state.activeIdx === 1 && t.monthSelected && t.monthSelected !== "ALL" && t.monthKey){
        rows = rows.filter(r => parseMonth(r[t.monthKey]) === t.monthSelected);
      }

      // Search filter
      const q = (t.q || "").trim().toLowerCase();
      if (q){
        rows = rows.filter(r =>
          Object.keys(r).some(k => (r[k] ?? "").toString().toLowerCase().includes(q))
        );
      }

      return rows;
    }

    
    // === Stats bridge (viewer solo muestra lo que calcula stats.html) ===
    const statsState = { payload: null, ready: false };

    function applyStats(){
      const p = statsState.payload;
      if (!p || p.status !== "OK"){
        $("s1k").textContent = "Entubación cecal";
        $("s1v").textContent = "—";
        $("s1s").textContent = p && p.status ? `Estado: ${p.status}` : "—";

        $("s2k").textContent = "Calidad preparación (Boston)";
        $("s2v").textContent = "—";
        $("s2s").textContent = p && p.error ? String(p.error).slice(0,120) : "—";

        $("s3k").textContent = (state.activeIdx === 0) ? "VCC totales" : "Estudios totales";
        $("s3v").textContent = "—";
        $("s3s").textContent = "—";
        return;
      }

      // Card 1
      $("s1k").textContent = "Entubación cecal";
      $("s1v").textContent = p.cecal?.value ?? "—";
      $("s1s").textContent = p.cecal?.meta ?? "—";

      // Card 2
      $("s2k").textContent = "Calidad preparación (Boston)";
      $("s2v").textContent = p.prep?.value ?? "—";
      $("s2s").textContent = p.prep?.meta ?? "—";

      // Card 3 (cambia por pestaña)
      if (state.activeIdx === 0){
        $("s3k").textContent = "VCC totales";
        $("s3v").textContent = (p.vcc ?? "—").toString();
        $("s3s").textContent = "Según tipo de estudio (Tabla 3)";
      } else {
        $("s3k").textContent = "Estudios totales";
        $("s3v").textContent = (p.total ?? "—").toString();
        $("s3s").textContent = "Total de filas (Tabla 3)";
      }
    }

    function requestStatsRecalc(){
      const fr = $("statsFrame");
      if (!fr || !fr.contentWindow) return;
      try{
        fr.contentWindow.postMessage({ type: "endodb_stats_run" }, "*");
      } catch {}
    }

    window.addEventListener("message", (e) => {
      const d = e.data;
      if (!d || d.type !== "endodb_stats") return;
      statsState.payload = d.payload || null;
      statsState.ready = true;
      applyStats();
    });


    function render(){
      const t = state.tables[state.activeIdx];
      const rows0 = getEffectiveRows(t);
      const cols0 = t.cols || [];
      const colNames = ["_row_id", ...cols0.map(c => c.title)].filter((v, i, a) => a.indexOf(v) === i);

      let rows = rows0;

      // sort
      if (state.sortKey){
        const k = state.sortKey;
        const dir = state.sortDir === "asc" ? 1 : -1;
        rows = [...rows].sort((a,b) => {
          const av = a[k] ?? "";
          const bv = b[k] ?? "";
          const an = Number(av), bn = Number(bv);
          const aNum = !Number.isNaN(an) && String(av).trim() !== "";
          const bNum = !Number.isNaN(bn) && String(bv).trim() !== "";
          if (aNum && bNum) return (an - bn) * dir;
          return String(av).localeCompare(String(bv), undefined, {numeric:true, sensitivity:"base"}) * dir;
        });
      }

      // paginate
      const ps = Math.max(1, t.pageSize|0);
      const total = rows.length;
      const maxPage = Math.max(1, Math.ceil(total / ps));
      t.page = Math.min(t.page, maxPage);
      const start = (t.page - 1) * ps;
      const pageRows = rows.slice(start, start + ps);

      const thead = $("thead");
      thead.innerHTML = "";
      const trh = document.createElement("tr");
      for (const c of colNames){
        const th = document.createElement("th");
        th.textContent = c === "_row_id" ? "row_id" : c;
        th.onclick = () => {
          if (state.sortKey === c){
            state.sortDir = (state.sortDir === "asc") ? "desc" : "asc";
          } else {
            state.sortKey = c;
            state.sortDir = "asc";
          }
          render();
        };
        trh.appendChild(th);
      }
      thead.appendChild(trh);

      const tbody = $("tbody");
      tbody.innerHTML = "";
      for (const r of pageRows){
        const tr = document.createElement("tr");
        for (const c of colNames){
          const td = document.createElement("td");
          td.textContent = (r[c] ?? "").toString();
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      $("meta").textContent =
        `${total.toLocaleString()} filas` +
        (t.q ? ` (filtradas por "${t.q}")` : "") +
        (state.activeIdx===1 && t.monthSelected!=="ALL" ? ` • mes: ${t.monthSelected}` : "") +
        (state.sortKey ? ` • orden: ${state.sortKey} (${state.sortDir})` : "");

      $("pageN").textContent = String(t.page);
      $("pageMax").textContent = String(maxPage);
      $("prev").disabled = t.page <= 1;
      $("next").disabled = t.page >= maxPage;

      $("debug").textContent = JSON.stringify(t.raw, null, 2);

      applyStats();
    }

    async function loadAll(){
      setStatus("warn", "Cargando…");
      try{
        for (let i=0;i<2;i++){
          const tid = state.tables[i].id;
          const baseUrl = CONFIG.baseUrl.replace(/\/+$/,"");

          const urlCols = `${baseUrl}/nc/tables/${tid}/columns`;
          const urlRows = `${baseUrl}/nc/tables/${tid}/rows`;

          const rCols = await fetchJson(urlCols);
          const rRows = await fetchJson(urlRows);

          state.tables[i].raw = {
            columns: { url: urlCols, ok: rCols.ok, status: rCols.status, json: rCols.json ?? rCols.text },
            rows:    { url: urlRows, ok: rRows.ok, status: rRows.status, json: rRows.json ?? rRows.text },
          };

          const cols = rCols.ok ? normalizeColumns(rCols.json) : [];
          const rows = rRows.ok ? normalizeRows(rRows.json, cols) : [];

          state.tables[i].cols = cols;
          state.tables[i].rows = rows;
        }

        buildMonths();
        renderMonths();
        setHeaderTitle();
        setStatus("ok", "Cargado");
        // refrescar stats desde stats.html
        requestStatsRecalc();
        render();
      } catch (e){
        console.error(e);
        setStatus("bad", "Error al cargar");
        $("debug").textContent = "Error cargando datos. Mirá consola del navegador.";
      }
    }

    // UI handlers
    $("tab1").onclick = () => setActive(0);
    $("tab2").onclick = () => setActive(1);

    const btnRefresh = $("btnRefresh");
    if (btnRefresh) btnRefresh.onclick = loadAll;

    $("q").addEventListener("input", (e) => {
      const t = state.tables[state.activeIdx];
      t.q = e.target.value || "";
      t.page = 1;
      render();
    });

    $("pageSize").addEventListener("input", (e) => {
      const t = state.tables[state.activeIdx];
      const n = parseInt(e.target.value || "25", 10);
      t.pageSize = Number.isFinite(n) && n > 0 ? n : 25;
      t.page = 1;
      render();
    });

    $("prev").onclick = () => { const t=state.tables[state.activeIdx]; t.page = Math.max(1, t.page - 1); render(); };
    $("next").onclick = () => { const t=state.tables[state.activeIdx]; t.page = t.page + 1; render(); };

    // Init
    $("pageSize").value = "25";
    setActive(0);

    // stats iframe boot
    const sf = $("statsFrame");
    if (sf){
      sf.addEventListener("load", () => requestStatsRecalc());
    }

    loadAll();
  </script>
</body>
</html>
